<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>The Juice â€” Crypto Escrow Bets</title>

  <!-- Styles -->
  <style>
    :root{
      --bg:#050608;
      --card:#16171b;
      --card-soft:#1c1d22;
      --text:#f4f4f5;
      --muted:#a1a1aa;
      --border:#27272f;
      --accent:#22c55e;
      --accent-ink:#052e16;
      --danger:#ef4444;
      --chip:#111114;
      --radius:18px;
      --fs:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:#000;
      color:var(--text);
      font:500 var(--fs)/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }

    .app{
  max-width:960px;
  margin:0 auto;
  padding:20px 20px 24px;
    }

    /* Header */
    .topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
  max-width:640px;
  margin-left:auto;
  margin-right:auto;
  padding:0 16px;
    }
  .top-actions{
  display:flex;
  align-items:center;
  gap:8px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
      font-size:18px;
    }
    .brand-logo{
      width:24px;
      height:24px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    border-radius:6px;
    background:transparent;
    border:none;
    padding:0;
  }
    .brand-logo img {
      width: 22px;
      height: 22px;
      display: block;
}
    /* Buttons / chips */
    .btn{
      border-radius:999px;
      border:1px solid var(--border);
      background:#101014;
      color:var(--text);
      padding:9px 16px;
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:background .12s ease,border-color .12s ease,transform .06s ease;
    }
    .btn:hover{
      transform:translateY(-1px);
      background:#18181b;
    }
    .btn.primary{
      background:#f9fafb;
      color:#020617;
      border-color:#f9fafb;
      font-weight:600;
    }
    .btn.primary:hover{
      background:#e5e7eb;
      border-color:#e5e7eb;
    }
    .btn.accent{
      background:var(--accent);
      border-color:var(--accent);
      color:var(--accent-ink);
      font-weight:600;
    }
    .btn.accent:hover{
      background:#16a34a;
      border-color:#16a34a;
    }
    .btn.ghost{
      border-color:var(--border);
      background:#101014;
      color:var(--text);
    }
    .btn.small{padding:6px 12px;font-size:13px}
    .btn.connected{
      border-color:var(--accent);
      color:var(--accent);
    }

    .chip{
      background:var(--chip);
      border-radius:999px;
      border:1px solid var(--border);
      padding:5px 10px;
      font-size:11px;
      opacity:0.82;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .chip.badge{
      border-color:var(--accent);
      color:var(--accent);
    }
    .chip a{
      color:inherit;
      text-decoration:none;
      white-space:nowrap;
    }
/* View Contract click flash */
    .chip:active {
      background: var(--accent);
      color: var(--accent-ink);
      transition: background 0.15s ease, color 0.15s ease;
    }
    .subbar{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-bottom:12px;
  max-width:640px;
  margin-left:auto;
  margin-right:auto;
  padding:0 16px;
    }
    .addr{
      border-radius:999px;
      border:1px solid var(--accent);
      background:#0b0b10;
      padding:8px 18px;
      margin-bottom:10px;   /* ðŸ‘ˆ add this */
      font-size:12px;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:center;
    }
    .subchips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      justify-content:space-between;
    }
    .subchips-left{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .subchips-right{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }

    /* Tabs */
    .tabs{
  display:flex;
  background:#050509;
  border-radius:999px;
  border:1px solid #27272f;
  padding:4px;
  margin:18px auto 24px;
  max-width:640px;   /* match card width */
    }
    .tab{
      flex:1;
      border-radius:999px;
      border:none;
      background:transparent;
      color:var(--muted);
      padding:8px 0;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      transition:background .12s ease,color .12s ease;
    }
    .tab.active{
      background:#f9fafb;
      color:#020617;
      font-weight:600;
    }

    /* Panels */
    .panel{display:none}
    .panel.active{display:block}

    /* Card */
    .card{
      border-radius:24px;
      background:var(--card);
      border:1px solid var(--border);
      padding:24px 24px 22px;       /* a bit more breathing room */
      box-shadow:0 18px 50px rgba(0,0,0,.55);
      max-width:520px;              /* narrower box like your reference */
      margin:0 auto 16px;           /* center + a little bottom gap */
    }
    .card-header{
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-bottom:18px;
    }
    .card-title{
      font-size:20px;
      font-weight:600;
      text-align:center;
      margin-bottom:4px;
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      margin-bottom:14px;
    }

    .label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
      display:block;
    }
    .input{
      width:100%;
      border-radius:999px;
      border:1px solid #27272f;
      background:#101014;
      color:var(--text);
      padding:10px 14px;
      font-size:14px;
    }
    .input::placeholder{color:#52525b}

    .row{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .row.wrap{flex-wrap:wrap}
    .stack{display:flex;flex-direction:column;gap:10px}

    .idea-input{
      border-radius:999px;
      border:1px solid #27272f;
      background:#101014;
      color:var(--text);
      padding:10px 16px;
      font-size:14px;
    }

    .stake-area{
      margin-top:18px;      /* slightly closer to subtitle */
      margin-bottom:20px;
      text-align:center;
    }
    .stake-label{
      font-size:13px;
      color:var(--muted);
      text-align:center;
      margin-bottom:4px;
    }
    .stake-main{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      margin-bottom:10px;
    }
      /* Bigger preset + / - buttons inside Create Bet */
    .stake-main .btn.small{
      padding:12px 22px;   /* taller & wider */
      font-size:15px;      /* bigger text */
      font-weight:600;     /* a bit bolder */
      min-width:88px;      /* gives each button a nice pill shape */
      border-radius:999px;
      text-align:center;
      justify-content:center;
    }
    .stake-symbol{
      font-size:20px;
      color:var(--muted);
    }
    .stake-amount{
      font-size:40px;
      font-weight:700;
      min-width:110px;
      text-align:center;
      border:none;
      outline:none;
      background:transparent;
      color:var(--accent);
      letter-spacing:-0.02em;
      line-height:1.05;
    }
    .stake-amount::-webkit-outer-spin-button,
    .stake-amount::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    .stake-toggle{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .stake-toggle button{
      border-radius:999px;
      border:1px solid #27272f;
      background:#101014;
      padding:4px 10px;
      font-size:11px;
      color:#e4e4e7;
      cursor:pointer;
    }
    .stake-toggle button.connected{
      border-color:var(--accent);
      color:var(--accent);
    }

    
    /* Join / Resolve pills â€“ match the clean ETH mock */
.quick-row{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:10px;
  margin-top:10px;
  width:100%;        /* âœ… forces full-row sizing */
}

.quick-row .quick-chip,
.quick-row .deadline-input{
  flex:1;
  min-width:0;
  text-align:center;
}

/* Big, soft segment-style buttons */
.quick-chip{
  border-radius:24px;
  border:1px solid #26262a;
  background:#26262a;
  color:#e4e4e7;
  padding:12px 0;
  font-size:13px;
  font-weight:500;
  cursor:pointer;
  white-space:nowrap;
}
.quick-chip:hover{
  background:#323238;
  border-color:#323238;
}

/* Custom minutes box styled to match the pills */
.deadline-input{
  border-radius:24px;
  border:1px solid #26262a;
  background:#101014;
  color:#e4e4e7;
  padding:12px 0;
  font-size:13px;
}

    .footer-note{
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
      text-align:right;
    }

    .status{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      min-height:16px;
    }

    /* Join / resolve */
    .join-input-row{
      margin-bottom:10px;
    }
    .join-input{
      flex:1;
    }
    .btn-clear{
      border-radius:999px;
      border:1px solid #27272f;
      background:#101014;
      color:#e4e4e7;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
    }

    .resolve-section{
      margin-top:16px;
      padding-top:12px;
      border-top:1px solid #27272f;
    }
    .resolve-title{
      font-size:13px;
      color:var(--muted);
      text-align:center;
      margin-bottom:4px;
    }
    .resolve-sub{
      font-size:11px;
      color:#71717a;
      text-align:center;
      margin-bottom:10px;
    }
    .vote-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-bottom:12px;
    }
    .vote-column-title{
      font-size:11px;
      color:#a1a1aa;
      text-align:center;
      margin-bottom:6px;
    }
    .vote-buttons{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    /* Share / QR */
    .share-card{
  margin-top:14px;
  border-radius:18px;
  background:var(--card-soft);
  border:1px solid var(--border);
  padding:14px 16px 16px;
  max-width:640px;
  margin-left:auto;
  margin-right:auto;
    }
    .share-title{
      font-size:13px;
      font-weight:500;
      margin-bottom:4px;
    }
    .share-help{
      font-size:11px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .qr-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .qr-box{
      border-radius:18px;
      border:1px dashed #27272f;
      background:#0b0b10;
      width:150px;
      height:150px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-top:10px;
    }

    /* Summary footer */
    .summary-card{
  margin-top:16px;
  border-radius:18px;
  background:#08080b;
  border:1px solid #27272f;
  padding:10px 16px;
  font-size:12px;
  max-width:640px;
  margin-left:auto;
  margin-right:auto;
    }
    .summary-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      gap:6px;
      flex-wrap:wrap;
    }
    .state-pill{
      border-radius:999px;
      border:1px solid #27272f;
      background:#101014;
      padding:4px 10px;
      font-size:11px;
      color:var(--muted);
    }
    .state-pill.ok{
      border-color:var(--accent);
      color:var(--accent);
      background:#022c22;
    }
    .summary-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .summary-label{color:#a1a1aa}
    .summary-value{font-weight:500}
    .summary-link{
      font-size:11px;
      color:#a1a1aa;
      text-decoration:underline;
    }

    .help-line{
      font-size:11px;
      color:#71717a;
      margin-top:4px;
      text-align:left;
    }

    /* Special buttons */
    #ethMinus,
    #ethPlus{
      padding:10px 12px;
      font-size:16px;
      border-radius:999px;
      border:1px solid #27272f;
      background:#101014;
      color:#e4e4e7;
    }
    #ethMinus:active,
    #ethPlus:active{
      background:var(--accent);
      color:var(--accent-ink);
      border-color:var(--accent);
    }

    /* Red reset */
    #btnReset{
      border:1px solid var(--danger);
      color:var(--danger);
      background:#101014;
    }
    #btnReset:hover,#btnReset:active{
      background:var(--danger);
      color:#020617;
      border-color:var(--danger);
    }
@media(min-width:900px){
  .card-title{font-size:20px;}
  .stake-amount{font-size:40px;}
  .stake-label{font-size:13px;}
}
    @media(max-width:640px){
  .app{padding:14px 12px 28px}
  .card{padding:16px}
  .subchips{flex-direction:column;align-items:flex-start}
    /* Join / Resolve buttons: 2 per row on phones */
  .quick-row{
    grid-template-columns:repeat(2, minmax(0, 1fr));
      /* On phones: let deadline pills wrap into a 2x2 grid */
  .quick-row{
    flex-wrap:wrap;
  }
  .quick-row .quick-chip,
  .quick-row .deadline-input{
    flex:1 1 calc(50% - 8px);
  }
  }

  /* NEW: make each chip a full-width row on mobile */
  .subchips .chip{
    width: 100%;
    justify-content: center;
    text-align: center;
    margin-bottom:6px; /* optional */
  }
  .quick-chip{
    width:100%;
    text-align:center;
  }
  .summary-card{font-size:11px}
  .top-actions{
    display: flex;
    gap: 10px;
  }
  /* contract pill â€” slightly smaller on phones */
  .addr{
    font-size:11px;
    padding:6px 12px;
  }
  .stake-amount{
    font-size:30px;
    min-width:90px;
  }
}
   
  </style>

  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header class="topbar">
    <div class="brand">
      <div class="brand-logo">
        <img src="favicon.png" alt="The Juice logo" />
      </div>
      <span>The Juice</span>
    </div>
    <div class="top-actions">
  <button id="btnSwitch" class="btn small ghost">Switch network</button>
  <button id="btnConnect" class="btn small ghost">Connect Wallet</button>
</div>
  </header>

  <div class="subbar">
    <div id="addrPill" class="addr" title="Escrow contract address (locked)"></div>
    <div class="subchips">
      <div class="subchips-left">
        <span id="chipNetwork" class="chip">Base â€¢ Sepolia â€¢ (84532)</span>
        <span class="chip badge">Fee 2.5%</span>
        <a class="chip" href="https://sepolia.basescan.org/address/0xD251F4aFB44Fa54Af8E714C8219d5a535Bc59433#code" target="_blank">
          Verified contract â†—
        </a>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button id="tabCreate" class="tab active">Create Bet</button>
    <button id="tabJoin" class="tab">Join &amp; Resolve</button>
  </div>

  <!-- Create panel -->
  <div id="panelCreate" class="panel active">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Create Bet</div>
      </div>

      <div class="card-sub">Set the bet, deadlines, and fund the escrow in one step.</div>

      <!-- Idea text (reuses ideaBox + shuffle) -->
      <div class="row" style="margin-bottom:10px">
        <input id="ideaBox" class="idea-input" type="text" value="Golf: Hole in one!" />
        <button id="btnShuffle" class="btn small ghost">Shuffle</button>
      </div>

      <!-- Stake area -->
      <div class="stake-area">
        <div class="stake-label">I want to bet</div>
        <div class="stake-main">
          <span class="stake-symbol">$</span>
          <input id="stakeMain" class="stake-amount" type="number" value="5" />
          <div class="stake-toggle">
            <button id="stakeModeEth">ETH</button>
            <button id="stakeModeUsd" class="connected">USD</button>
          </div>
        </div>

        <!-- hidden fields actually used by contract / logic -->
        <input id="stakeEth" type="hidden" value="0.0014"/>
        <input id="stakeUsd" type="hidden" value="5"/>

        <div class="row" style="justify-content:center;gap:8px;margin-top:6px">
          <button id="usd1" class="btn small ghost">$1</button>
          <button id="usd5" class="btn small ghost">$5</button>
          <button id="usd20" class="btn small ghost">$20</button>
          <button id="ethMinus" class="btn small ghost">âˆ’</button>
          <button id="ethPlus"  class="btn small ghost">+</button>
        </div>
      </div>

      <!-- Join deadline -->
      <div style="margin-top:14px">
        <div class="label">Join deadline (minutes)</div>
        <div class="row wrap">
          <div class="quick-row">
            <button class="quick-chip" data-join="15">Quick (15m)</button>
            <button class="quick-chip" data-join="60">1h</button>
            <button class="quick-chip" data-join="1440">1 Day</button>
            <input id="joinMins" class="input deadline-input" type="number" min="1" max="43200" value="15"/>
          </div>
        </div>
      </div>

      <!-- Resolve deadline -->
      <div style="margin-top:12px">
        <div class="label">Resolve deadline (minutes)</div>
        <div class="row wrap">
          <div class="quick-row">
            <button class="quick-chip" data-resolve="30">+30m</button>
            <button class="quick-chip" data-resolve="120">+2h</button>
            <button class="quick-chip" data-resolve="2880">+2 Days</button>
            <input id="resolveMins" class="input deadline-input" type="number" min="15" max="43200" value="30"/>
          </div>
        </div>
      </div>

      <div class="footer-note">USD values are estimates only.</div>

      <!-- Actions -->
      <div class="row" style="margin-top:16px;gap:10px">
        <button id="btnCreate" class="btn accent" style="flex:1">Create &amp; Fund</button>
        <button id="btnReset" class="btn" style="min-width:90px">Reset</button>
      </div>

      <div id="createStatus" class="status"></div>
    </div>
  </div>

  <!-- Join / Resolve panel -->
  <div id="panelJoin" class="panel">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Join &amp; Resolve</div>
      </div>
      <div id="resolveNote" class="card-sub">Paste a bet ID to join, refund, or finalize.</div>

      <!-- Bet ID -->
      <div class="join-input-row row">
        <input id="betId" class="input join-input" placeholder="Paste bet IDâ€¦" />
        <button id="btnClearId" class="btn-clear">Clear</button>
      </div>

      <!-- Join / refund -->
      <div class="stack" style="margin-top:8px">
        <button id="btnJoin" class="btn primary" style="width:100%">Join Bet</button>
        <button id="btnRefund" class="btn ghost" style="width:100%">Request Refund</button>
      </div>

      <!-- Resolve winner -->
      <div class="resolve-section">
        <div class="resolve-title">Resolve winner</div>
        <div class="resolve-sub">Both sides choose the winner. If they match, payout is automatic.</div>

        <div class="vote-grid">
          <div>
            <div class="vote-column-title">I created this bet</div>
            <div class="vote-buttons">
              <button id="creatorWon" class="btn ghost">I Won</button>
              <button id="creatorSaysOpponent" class="btn ghost">Opponent Won</button>
            </div>
          </div>
          <div>
            <div class="vote-column-title">I joined this bet</div>
            <div class="vote-buttons">
              <button id="opponentSaysCreator" class="btn ghost">Creator Won</button>
              <button id="opponentWon" class="btn ghost">I Won</button>
            </div>
          </div>
        </div>

        <button id="btnPayout" class="btn accent" style="width:100%;margin-top:6px">
          Finalize &amp; Payout
        </button>
      </div>

      <div id="actionStatus" class="status"></div>
      <div id="newBetNote" class="status" style="text-align:center;display:none">ðŸ†• New bet link prepared â€” share the QR!
      </div>
    </div>
    
    <!-- Share / QR -->
    <div class="share-card">
      <div class="share-title">Share link &amp; QR</div>
      <div class="share-help">Send this link or QR to your opponent so they open the exact bet.</div>

      <div class="row wrap">
        <button id="btnCopy" class="btn small ghost">Copy link</button>
        <input id="shareUrl" class="input" style="flex:1" readonly/>
      </div>

      <div class="qr-box" id="qrBox"></div>
    </div>
  </div>

  <!-- Summary footer -->
  <div class="summary-card">
    <div class="summary-top">
      <div id="sbState" class="state-pill">Not connected</div>
      <div class="chip">Base Sepolia</div>
    </div>

    <div class="summary-row">
      <span class="summary-label">Pot value</span>
      <span class="summary-value"><span id="sbPotEth">0.0000</span> ETH (<span id="sbPotUsd">$0.00</span>)</span>
    </div>
    <div class="summary-row">
      <span class="summary-label">Winner gets</span>
      <span class="summary-value"><span id="sbWinEth">0.0000</span> ETH (<span id="sbWinUsd">$0.00</span>)</span>
    </div>

    <div class="summary-row" style="margin-top:6px">
      <span class="summary-label">Last transaction</span>
      <a id="lastTx" class="summary-link" href="#" target="_blank" rel="noopener">View on Basescan</a>
    </div>

    <div class="help-line">Refunds are fee-free if deadlines pass.</div>
  </div>
</div>

<!-- Logic -->
<script>
/* ---------- Config ---------- */
const BASE = { idHex: '0x14a34', rpc: 'https://sepolia.base.org', explorer: 'https://sepolia.basescan.org' };
const FEE_BPS = 250;        // fixed 2.5%
let   ETH_USD = 3500;       // preview only
const CONTRACT_ADDRESS = '0xD251F4aFB44Fa54Af8E714C8219d5a535Bc59433';

/* ---------- Shortcuts ---------- */
const $  = id => document.getElementById(id);
const fmtUsd = v => '$' + v.toFixed(2);

/* ---------- Fill header contract pill ---------- */
$('addrPill').textContent = `Contract: ${CONTRACT_ADDRESS}`;

/* ---------- QR + share helpers ---------- */
function currentShareUrl() {
  const betId = $('betId').value;
  try{
    const u = new URL(location.href);
    if (betId) {
      u.searchParams.set('bet', betId);
    } else {
      u.searchParams.delete('bet');
    }
    return u.toString();
  }catch{
    return location.href;
  }
}
let qr = null;
function renderQR(){
  const node = $('qrBox');
  if (!node) return;
  node.innerHTML = '';
  qr = new QRCode(node,{
    text: currentShareUrl(),
    width: 140,
    height:140,
    colorDark:'#ffffff',
    colorLight:'#0b0b10',
    correctLevel: QRCode.CorrectLevel.M
  });
}
function setCopyPulse(el){
  el.classList.add('connected');
  setTimeout(()=>el.classList.remove('connected'), 800);
}

/* ---------- USD/ETH preview ---------- */
function updatePreview(){
  const eth = parseFloat($('stakeEth').value || '0') || 0;
  const pot = eth * 2;
  const win = pot * (1 - FEE_BPS/10000);

  const potEthEl = $('sbPotEth');
  if (potEthEl) potEthEl.textContent = pot.toFixed(4);

  const potUsdEl = $('sbPotUsd');
  if (potUsdEl) potUsdEl.textContent = fmtUsd(pot * ETH_USD);

  const winEthEl = $('sbWinEth');
  if (winEthEl) winEthEl.textContent = win.toFixed(4);

  const winUsdEl = $('sbWinUsd');
  if (winUsdEl) winUsdEl.textContent = fmtUsd(win * ETH_USD);
}

/* Hidden fields kept in ETH and USD */
function applyStakeFromEth(rawEth){
  const eth = Math.max(0, Number(rawEth) || 0);
  $('stakeEth').value = eth.toFixed(4);
  $('stakeUsd').value = (eth * ETH_USD).toFixed(0);

  if (stakeMode === 'ETH'){
    $('stakeMain').value = eth.toFixed(4);
  }else{
    $('stakeMain').value = (eth * ETH_USD).toFixed(0);
  }
  updatePreview();
}

/* Single stake box + mode toggle */
let stakeMode = 'USD'; // default: show USD in big box

function handleStakeMainInput(){
  const num = Number($('stakeMain').value) || 0;
  if (stakeMode === 'ETH'){
    applyStakeFromEth(num);
  }else{
    const eth = num / ETH_USD;
    applyStakeFromEth(eth);
  }
}
function setStakeMode(mode){
  if (mode !== 'ETH' && mode !== 'USD') return;
  stakeMode = mode;
  const eth = parseFloat($('stakeEth').value || '0') || 0;

  $('stakeModeEth').classList.toggle('connected', mode === 'ETH');
  $('stakeModeUsd').classList.toggle('connected', mode === 'USD');

  if (mode === 'ETH'){
    $('stakeMain').step = '0.0001';
    $('stakeMain').value = eth.toFixed(4);
  }else{
    $('stakeMain').step = '1';
    $('stakeMain').value = (eth * ETH_USD).toFixed(0);
  }
}

/* ---------- Wallet / ethers ---------- */
let provider, signer;
const ABI = [
  {type:'function',stateMutability:'payable',   name:'createBet',   inputs:[{name:'stakeWei',type:'uint256'},{name:'feeBps',type:'uint16'},{name:'joinWindowSeconds',type:'uint64'},{name:'resolveWindowSeconds',type:'uint64'}], outputs:[{name:'betId',type:'uint256'}]},
  {type:'function',stateMutability:'payable',   name:'joinBet',     inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'confirmWinner',inputs:[{name:'betId',type:'uint256'},{name:'creatorWon',type:'bool'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'refund',      inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'resolve',     inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'view',      name:'getBet',      inputs:[{name:'betId',type:'uint256'}], outputs:[{type:'address'},{type:'address'},{type:'uint256'},{type:'uint16'},{type:'uint64'},{type:'uint64'},{type:'uint64'},{type:'uint8'},{type:'int8'},{type:'int8'}]},
  {type:'function',stateMutability:'view',      name:'nextBetId',   inputs:[], outputs:[{type:'uint256'}]}
];
async function ensureBase(){
  if (!window.ethereum){ alert('MetaMask not found'); throw new Error('no wallet'); }
  const chain = await window.ethereum.request({ method:'eth_chainId' });
  if (chain !== BASE.idHex){
    try{
      await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BASE.idHex }] });
    }catch(e){
      if (e.code === 4902){
        await window.ethereum.request({
          method:'wallet_addEthereumChain',
          params:[{ chainId: BASE.idHex, chainName:'Base Sepolia',
                    nativeCurrency:{name:'ETH',symbol:'ETH',decimals:18},
                    rpcUrls:[BASE.rpc], blockExplorerUrls:[BASE.explorer]}]
        });
      }else{ throw e; }
    }
  }
}
async function connect(){
  try{
    await ensureBase();
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts',[]);
    signer = await provider.getSigner();
    $('sbState').textContent = 'Connected';
    const netChip = $('chipNetwork');
    if (netChip) netChip.classList.add('badge');
    $('sbState').classList.add('ok');
    $('btnConnect').classList.add('connected');
  }catch(e){
    $('sbState').textContent = 'Not connected';
    $('sbState').classList.remove('ok');
  }
}
function getContract(){
  if (!signer) throw new Error('Connect your wallet first.');
  return new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
}
function requireBetId(){
  const raw = String(($('betId').value || '').trim());
  if (!raw) throw new Error('Enter a bet ID first.');
  if (!/^\d+$/.test(raw)) throw new Error('Bet ID must be a number.');
  return BigInt(raw);
}

/* ---------- Actions ---------- */
async function doCreate(){
  $('createStatus').textContent = 'Sendingâ€¦';
  try{
    if (!signer) await connect();
    const c = getContract();
    const stakeEth = String($('stakeEth').value || '0');

    if (Number(stakeEth) <= 0){
      throw new Error('Stake must be greater than zero.');
    }

    const jm = Math.max(5,  Math.min(43200, parseInt($('joinMins').value || '15', 10)));
    const rm = Math.max(30, Math.min(43200, parseInt($('resolveMins').value || '30', 10)));
    $('joinMins').value = jm;
    $('resolveMins').value = rm;

    const stakeWei = ethers.parseEther(stakeEth);
    const tx = await c.createBet(
      stakeWei,
      FEE_BPS,
      BigInt(jm * 60),
      BigInt(rm * 60),
      { value: stakeWei }
    );
    $('createStatus').textContent = 'Pending ' + tx.hash;

    const rc = await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('createStatus').textContent = 'âœ… Bet created';

    const nextId = await c.nextBetId();
    const betId = (BigInt(nextId) - 1n).toString();
    $('betId').value = betId;
    $('shareUrl').value = currentShareUrl();
    renderQR();
    $('newBetNote').style.display = 'block';
  }catch(e){
    console.error('createBet error',e);
    $('createStatus').textContent = 'âŒ ' + (e?.shortMessage||e?.message||e);
  }
}

async function doJoin(){
  $('actionStatus').textContent = 'Sendingâ€¦';
  try{
    if (!signer) await connect();
    const c = getContract();
    const betId = requireBetId();
    const b = await c.getBet(betId);

    if (b[0] === ethers.ZeroAddress){
      $('actionStatus').textContent = 'âŒ Bet not found';
      return;
    }
    if (b[1] !== ethers.ZeroAddress){
      $('actionStatus').textContent = 'âŒ Bet already has an opponent';
      return;
    }

    const stakeWei = b[2];
    const tx = await c.joinBet(betId,{ value: stakeWei });
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = 'âœ… Joined bet #' + betId;
  }catch(e){
    $('actionStatus').textContent = 'âŒ ' + (e?.shortMessage||e?.message||e);
  }
}

async function doVote(creatorWon){
  $('actionStatus').textContent = 'Sendingâ€¦';
  try{
    if (!signer) await connect();
    const c = getContract();
    const betId = requireBetId();
    const b = await c.getBet(betId);

    if (b[0] === ethers.ZeroAddress){
      $('actionStatus').textContent = 'âŒ Bet not found';
      return;
    }
    const state = Number(b[7]);
    if (state !== 1){
      $('actionStatus').textContent = 'âŒ Voting not available';
      return;
    }

    const user = await signer.getAddress();
    if (user !== b[0] && user !== b[1]){
      $('actionStatus').textContent = 'âŒ You are not part of this bet';
      return;
    }

    if ((user === b[0] && b[8] !== -1) || (user === b[1] && b[9] !== -1)){
      $('actionStatus').textContent = 'âœ… Vote already submitted';
      return;
    }

    const tx = await c.confirmWinner(betId, Boolean(creatorWon));
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = 'âœ… Vote submitted';
  }catch(e){
    $('actionStatus').textContent = 'âŒ ' + (e?.shortMessage||e?.message||e);
  }
}

async function doRefund(){
  $('actionStatus').textContent = 'Sendingâ€¦';
  try{
    if (!signer) await connect();
    const c = getContract();
    const betId = requireBetId();
    const tx = await c.refund(betId);
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = 'âœ… Refund sent';
  }catch(e){
    $('actionStatus').textContent = 'âŒ ' + (e?.shortMessage||e?.message||e);
  }
}

async function doPayout(){
  $('actionStatus').textContent = 'Sendingâ€¦';
  try{
    if (!signer) await connect();
    const c = getContract();
    const betId = requireBetId();
    const tx = await c.resolve(betId);
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = 'âœ… Payout finalized';
  }catch(e){
    $('actionStatus').textContent = 'âŒ ' + (e?.shortMessage||e?.message||e);
  }
}

/* ---------- Bet Ideas ---------- */
const IDEAS = [
  "Make a 3-point shot from the top of the key",
  "Darts: Hit any double in 3 throws",
  "Darts: You vs Me",
  "Darts: Bullzeye",
  "Drink: Chug under 1 minute",
  "Hockey: Hit the crossbar",
  "Lacrosse: Top right corner",
  "Human: No way!",
  "Human: I bet you can't",
  "Cornhole: 2 in a row",
  "Bottle Flip: 3 out of 5",
  "Soccer: Crossbar in 3 tries",
  "Golf: Hole in one!",
  "Golf: 3-putt?",
  "Golf: 2-putt or better",
  "Golf: Green-in-regulation?",
  "Golf: Fairway off the tee",
  "Gaming: 1 v 1",
  "Speed: I'll beat you there",
  "Pool: You vs Me",
  "Pool: Bank shot within 2 tries",
  "Golf: Closest-to-the-pin",
  "Golf: On the green?",
  "Golf: Low score",
  "Golf: Match Play",
  "Ping pong: Serve an ace in 5 serves"
];
function shuffleIdea(){
  $('ideaBox').value = IDEAS[Math.floor(Math.random()*IDEAS.length)];
}

/* ---------- New bet link ---------- */
function startNewBet(){
  $('betId').value = '';
  $('shareUrl').value = '';
  $('qrBox').innerHTML = '';
  $('newBetNote').style.display = 'none';
}

/* ---------- Wire UI ---------- */
window.addEventListener('DOMContentLoaded', ()=>{
  // stake defaults (start from ETH value, show USD)
  applyStakeFromEth(0.0014);
  setStakeMode('USD');
  $('stakeMain').addEventListener('input', handleStakeMainInput);

  // Mode toggle
  $('stakeModeEth').onclick = ()=> setStakeMode('ETH');
  $('stakeModeUsd').onclick = ()=> setStakeMode('USD');

  // Quick USD buttons
  $('usd1').onclick  = ()=>{ setStakeMode('USD'); $('stakeMain').value = 1;  handleStakeMainInput(); };
  $('usd5').onclick  = ()=>{ setStakeMode('USD'); $('stakeMain').value = 5;  handleStakeMainInput(); };
  $('usd20').onclick = ()=>{ setStakeMode('USD'); $('stakeMain').value = 20; handleStakeMainInput(); };

  // +/- in ETH space
  $('ethPlus').onclick = ()=>{
    const v = Math.max(0, parseFloat($('stakeEth').value || '0') + 0.0001);
    applyStakeFromEth(v);
  };
  $('ethMinus').onclick = ()=>{
    const v = Math.max(0, parseFloat($('stakeEth').value || '0') - 0.0001);
    applyStakeFromEth(v);
  };

  // Quick deadline chips
  document.querySelectorAll('[data-join]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $('joinMins').value = btn.getAttribute('data-join');
    });
  });
  document.querySelectorAll('[data-resolve]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $('resolveMins').value = btn.getAttribute('data-resolve');
    });
  });

  // QR + share
  renderQR();
  $('betId').addEventListener('input', ()=>{
    $('shareUrl').value = currentShareUrl();
    renderQR();
  });
  $('shareUrl').value = currentShareUrl();
  $('btnCopy').onclick = async ()=>{
    try{
      await navigator.clipboard.writeText($('shareUrl').value);
      setCopyPulse($('btnCopy'));
    }catch{}
  };

  // Connect / switch / new bet
$('btnConnect').onclick = connect;
$('btnSwitch').onclick = async ()=>{
  try{
    await ensureBase();
    $('btnSwitch').classList.add('connected');
  }catch{}
};

const newBetBtn = $('btnNewBet');
if (newBetBtn) {
  newBetBtn.onclick = () => {
    startNewBet();
    newBetBtn.classList.add('connected');
  };
}
  
  // Actions
  $('btnCreate').onclick = doCreate;
  $('btnReset').onclick  = ()=>{
    $('joinMins').value = '15';
    $('resolveMins').value = '30';
    applyStakeFromEth(0.0014);
    startNewBet();
  };
  $('btnJoin').onclick    = doJoin;
  $('btnRefund').onclick  = doRefund;
  $('creatorWon').onclick = ()=>doVote(true);
  $('creatorSaysOpponent').onclick = ()=>doVote(false);
  $('opponentSaysCreator').onclick = ()=>doVote(true);
  $('opponentWon').onclick = ()=>doVote(false);
  $('btnPayout').onclick  = doPayout;

  // Shuffle ideas
  $('btnShuffle').onclick = shuffleIdea;

  // Clear bet ID button
  $('btnClearId').onclick = ()=>{
    startNewBet();
    $('betId').value = '';
  };

  // Tabs
  const tabCreate = $('tabCreate');
  const tabJoin   = $('tabJoin');
  const panelCreate = $('panelCreate');
  const panelJoin   = $('panelJoin');
  tabCreate.onclick = ()=>{
    tabCreate.classList.add('active');
    tabJoin.classList.remove('active');
    panelCreate.classList.add('active');
    panelJoin.classList.remove('active');
  };
  tabJoin.onclick = ()=>{
    tabJoin.classList.add('active');
    tabCreate.classList.remove('active');
    panelJoin.classList.add('active');
    panelCreate.classList.remove('active');
  };

  // Read ?bet= on load
  const p = new URLSearchParams(location.search);
  const b = p.get('bet');
  if (b){
    $('betId').value = b;
    $('shareUrl').value = currentShareUrl();
    renderQR();
  }

  // Initial preview
  updatePreview();
});
</script>
</body>
</html>
