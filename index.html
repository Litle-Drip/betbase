<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>The Juice â€” Crypto Escrow Bets</title>
  <style>
  :root{--bg:#0b1220;--card:#0f172a;--text:#e2e8f0;--muted:#94a3b8;--border:#1f2a44;--accent:#22c55e;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1a);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text)}
  .container{max-width:1200px;margin:20px auto;padding:0 16px}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px}
  h1{font-size:26px;margin:0}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{font-size:26px}
  .pill{background:#052e16;border:1px solid #16a34a;color:#86efac;padding:6px 12px;border-radius:999px;font-size:12px;display:inline-block}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.25);height:100%}
  .grid{display:grid;gap:14px}
  @media(min-width:900px){.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .label{font-size:13px;color:var(--muted)}
  .input{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0b1324;color:var(--text)}
  .btn{padding:9px 13px;border:1px solid var(--accent);background:#0b1324;border-radius:12px;color:#d1fae5;cursor:pointer;transition:transform .06s ease, box-shadow .12s ease, background .2s ease, border-color .2s ease, color .2s ease}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
  .btn-plain{background:#fff;color:#111;border:1px solid #1f2937;border-radius:12px;padding:9px 13px;font-weight:600}
  .btn-connected{background:#16a34a !important;border-color:#16a34a !important;color:#052e16 !important}
  .btn-highlight{background:#16a34a !important;border-color:#16a34a !important;color:#052e16 !important}
  .pulse{animation:pulse .7s ease 1}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted)}
  #qrBox{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#0b1324;display:flex;align-items:center;justify-content:center;min-width:136px;min-height:136px}
  .qrHint{font-size:12px;color:#94a3b8;opacity:.85;text-align:center}
  .primary{background:#16a34a;border-color:#16a34a;color:#052e16}
  .primary:hover{filter:brightness(1.05)}
  .stickybar{position:sticky;bottom:0;z-index:5;background:rgba(11,19,36,.9);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:14px;margin-top:14px;padding:12px}
  .stickygrid{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .chip{background:#0b1324;border:1px solid var(--border);border-radius:999px;padding:5px 12px;font-size:12px;color:#cbd5e1}
  .state-chip{ padding:4px 10px; border-radius:999px; border:1px solid var(--border); }
  .state-ok{ background:#052e16; color:#86efac; border-color:#16a34a; }
  .voteGrid{grid-template-columns:1fr 1fr;gap:12px;align-items:stretch;grid-auto-rows:1fr}
  .voteCard{display:flex;flex-direction:column;height:100%}
  .voteTitle{font-size:14px;font-weight:600;color:#e2e8f0;letter-spacing:.2px;margin-bottom:4px}
  .addrMono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    background:#0b1324; color:#e2e8f0; border:1px solid var(--border);
    border-radius:10px; padding:8px 10px; height:36px;
    width:360px; white-space:nowrap; overflow-x:auto; overflow-y:hidden;
  }
  .addrMono::-webkit-scrollbar{ height:6px }
  .toast{position:fixed;right:16px;top:16px;background:#0b1324;border:1px solid #22c55e;color:#e2e8f0;padding:10px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.35);opacity:0;transform:translateY(-6px);transition:all .25s ease;z-index:9999}
  .toast.show{opacity:1;transform:translateY(0)}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand"><span class="logo">ðŸ§ƒ</span><h1>The Juice â€” Crypto Escrow Bets</h1></div>
      <div class="row">
        <label class="label" style="margin-right:6px">Contract:</label>
        <input id="contractAddr" class="addrMono" value="0xA235352c02A9EEf99001319fb20a35A8a45479b4" readonly />
        <button id="copyContract" class="btn">Copy</button>
        <button id="connect" class="btn-plain">Connect Wallet</button>
        <button id="switch" class="btn">Switch to Base Sepolia</button>
        <button id="newBet" class="btn">Start New Bet</button>
      </div>
    </div>

    <div id="netPill" class="pill">Network: â€”</div>
    <p class="small" style="margin-top:10px">Create a bet, your friend joins and matches the stake, you both confirm the winner, and payout happens. Refunds are fee-free.</p>

    <div class="grid grid-3">
      <!-- Create Bet -->
      <div class="card">
        <h3>Create Bet</h3>
        <div class="row">
          <div><label class="label">Stake (ETH)</label><input id="stake" class="input" type="number" step="0.0001" value="0.0014" style="width:140px"/></div>
          <div><label class="label">Stake (USD)</label><input id="stakeUsdInput" class="input" type="number" step="1" value="5" style="width:140px"/></div>
          <div class="row" style="gap:6px;align-items:flex-end"><button id="stakeMinus" class="btn" title="Decrease">âˆ’</button><button id="stakePlus" class="btn" title="Increase">+</button></div>
        </div>
        <div class="row small"><span style="opacity:.9">Set by USD:</span><button class="btn" id="q1">$1</button><button class="btn" id="q5">$5</button><button class="btn" id="q20">$20</button><span style="margin-left:8px">Custom</span><input id="qCustomUsd" class="input" type="number" min="0" step="1" value="10" style="width:100px"/></div>
        <div id="stakeUsd" class="small">â‰ˆ $0.00</div>

        <div style="height:10px"></div>
        <label class="label">Fee (fixed at 2.5%)</label>
        <input id="feeBps" class="input" value="250" readonly disabled/>

        <div style="height:10px"></div>
        <label class="label">Join deadline (minutes) <span class="small">(5â€“43200)</span></label>
        <input id="joinMins" class="input" type="number" min="5" max="43200" value="15"/>

        <div style="height:10px"></div>
        <label class="label">Resolve deadline (minutes) <span class="small">(30â€“43200)</span></label>
        <input id="resolveMins" class="input" type="number" min="30" max="43200" value="30"/>

        <div style="height:10px"></div>
        <div class="row"><button id="btnCreate" class="btn primary">Create & Fund</button><button id="btnReset" class="btn">Reset</button></div>
        <div id="createStatus" class="small" style="margin-top:10px"></div>
      </div>

      <!-- Join / Resolve -->
      <div class="grid" style="gap:14px">
        <div class="card">
          <h3>Join / Resolve</h3>
          <div class="small" id="resolveNote" style="margin-top:4px;opacity:.9">Waiting for both votesâ€¦</div>
          <div class="row" style="margin:10px 0">
            <button id="btnJoin" class="btn">Join & Match Stake</button>
            <button id="btnRefund" class="btn">Request Refund</button>
            <button id="btnResolve" class="btn">Resolve Payout</button>
          </div>
          <div class="grid voteGrid">
            <div class="card voteCard" style="padding:10px">
              <div class="voteTitle">Creator vote</div>
              <div class="row" style="margin-top:6px">
                <button id="creatorWon" class="btn">Creator won</button>
                <button id="creatorSaysOpponent" class="btn">Opponent won</button>
              </div>
            </div>
            <div class="card voteCard" style="padding:10px">
              <div class="voteTitle">Opponent vote</div>
              <div class="row" style="margin-top:6px">
                <button id="opponentSaysCreator" class="btn">Creator won</button>
                <button id="opponentWon" class="btn">Opponent won</button>
              </div>
            </div>
          </div>
          <div class="small" id="betStatus" style="margin-top:6px;opacity:.9">Status: â€”</div>
          <div id="actionStatus" class="small" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <h3>Bet Ideas</h3>
          <div class="small">Tap shuffle to get a quick, fair challenge idea you can use IRL.</div>
          <div class="row" style="margin-top:8px">
            <input id="ideaBox" class="input" readonly value="Make a 3-point shot from the top of the key"/>
            <button id="ideaShuffle" class="btn">Shuffle</button>
          </div>
        </div>
      </div>

      <!-- Share / QR -->
      <div class="card">
        <h3>Share / QR</h3>
        <div class="small">Show this to your opponent so they can open the exact bet.</div>
        <div class="row" style="margin-top:8px">
          <input id="betId" class="input" style="width:140px" placeholder="(auto-filled)" value=""/>
          <input id="shareUrl" class="input" readonly placeholder="Create a bet to generate a share link"/>
          <button id="copyBtn" class="btn">Copy link</button>
        </div>
        <div id="qrBox"><div class="qrHint">QR will appear here. Create a bet to generate a new link and QR.</div></div>
      </div>
    </div>

    <!-- Sticky summary -->
    <div class="stickybar">
      <div class="stickygrid">
        <div class="chip state-chip" id="sbState">â€”</div>
        <div class="chip">Fee: <strong>2.5%</strong></div>
        <div class="chip">Pot: <strong><span id="sbPotEth">0.0000</span> ETH</strong> (<span id="sbPotUsd">$0.00</span>)</div>
        <div class="chip">Winner gets: <strong><span id="sbWinEth">0.0000</span> ETH</strong> (<span id="sbWinUsd">$0.00</span>)</div>
        <a id="lastTx" class="chip" href="#" target="_blank" style="text-decoration:underline">View on Explorer</a>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* -------- Networks -------- */
const BASE_MAIN = { name:'Base Mainnet', idHex:'0x2105', rpc:'https://mainnet.base.org', explorer:'https://basescan.org' };
const BASE_SEP  = { name:'Base Sepolia', idHex:'0x14a34', rpc:'https://sepolia.base.org', explorer:'https://sepolia.basescan.org' };
const TARGET    = BASE_SEP; // our "Switch" button targets Sepolia on purpose

const FEE_BPS = 250;
let   ETH_USD = 3500; // preview only
const CONTRACT_ADDRESS = '0xA235352c02A9EEf99001319fb20a35A8a45479b4'; // LOCKED

/* -------- Shortcuts -------- */
const $ = (id)=>document.getElementById(id);
function toast(msg){ const t=$('toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); }
function setState(text){ const el=$('sbState'); el.textContent=text; el.classList.add('state-chip'); if (text.startsWith('Connected')) el.classList.add('state-ok'); }
function setNetPillConnected(n){ const p=$('netPill'); if(!p) return; p.textContent=`âœ… ${n.name} (${parseInt(n.idHex,16)})`; p.classList.add('pulse'); setTimeout(()=>p.classList.remove('pulse'),500); }
function setNetPillWarn(txt){ const p=$('netPill'); if(!p) return; p.textContent=txt; p.classList.add('pulse'); setTimeout(()=>p.classList.remove('pulse'),500); }
function highlight(el){ if(!el) return; el.classList.add('btn-highlight'); setTimeout(()=>el.classList.remove('btn-highlight'),900); }
function updatePreview(){ const se=parseFloat($('stake').value||'0')||0; const pot=se*2; const win=pot*(1-FEE_BPS/10000); $('sbPotEth').textContent=pot.toFixed(4); $('sbPotUsd').textContent=`$${(pot*ETH_USD).toFixed(2)}`; $('sbWinEth').textContent=win.toFixed(4); $('sbWinUsd').textContent=`$${(win*ETH_USD).toFixed(2)}`; }
function syncUsdFromEth(){ const v=parseFloat($('stake').value||'0'); $('stakeUsdInput').value=(v*ETH_USD).toFixed(0); updatePreview(); }
function syncEthFromUsd(){ const v=parseFloat($('stakeUsdInput').value||'0'); $('stake').value=(v/ETH_USD).toFixed(4); updatePreview(); }

/* -------- URL/QR helpers -------- */
function ensureShareDefaults(){ const shareEl=$('shareUrl'); if(shareEl && !shareEl.value){ try{ const u=new URL(location.href); u.searchParams.delete('bet'); shareEl.value=u.toString(); }catch(_){}} renderQR(); }
function setBetId(id){ const betIdEl=$('betId'), shareEl=$('shareUrl'); if(betIdEl) betIdEl.value=String(id); try{ const u=new URL(location.href); u.searchParams.set('bet', String(id)); if(shareEl) shareEl.value=u.toString(); history.replaceState(null,'',u.toString()); }catch(_){ } renderQR(); }
function clearBetFromUrl(){ try{ const u=new URL(location.href); u.searchParams.delete('bet'); history.replaceState(null,'',u.toString()); }catch(_){} const shareEl=$('shareUrl'); if(shareEl){ try{ const u=new URL(location.href); u.searchParams.delete('bet'); shareEl.value=u.toString(); }catch(_){} } renderQR(); }
function renderQR(){ const qrBox=$('qrBox'), shareEl=$('shareUrl'); if(!qrBox) return; qrBox.innerHTML=''; if(!window.QRCode){ const d=document.createElement('div'); d.className='qrHint'; d.textContent='QR library not loaded.'; qrBox.appendChild(d); return; } const text=(shareEl && shareEl.value)?shareEl.value:location.href; new QRCode(qrBox,{ text, width:140, height:140, colorDark:'#ffffff', colorLight:'#0b1324', correctLevel: QRCode.CorrectLevel.M }); }

/* -------- Initial QR & ?bet= -------- */
(function initQR(){ const betIdEl=$('betId'), shareEl=$('shareUrl'); try{ const p=new URLSearchParams(location.search); const id=p.get('bet'); if(id && betIdEl){ betIdEl.value=id; } }catch(_){} ensureShareDefaults(); betIdEl?.addEventListener('input', ()=>{ try{ const u=new URL(location.href); const id=(betIdEl.value||'').trim(); if(id) u.searchParams.set('bet', id); else u.searchParams.delete('bet'); if(shareEl) shareEl.value=u.toString(); history.replaceState(null,'',u.toString()); }catch(_){} renderQR(); refreshBetStatus(); }); shareEl?.addEventListener('input', renderQR); $('copyBtn')?.addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(shareEl.value); toast('Link copied'); highlight($('copyBtn')); }catch(_){ } }); })();

/* -------- Wallet / Ethers -------- */
let provider, signer, activeNet = null;

async function detectNetworkUI(){
  try{
    if (!window.ethereum){ setNetPillWarn('Wallet not found'); return; }
    const chainId = await window.ethereum.request({ method:'eth_chainId' });
    if (chainId === BASE_MAIN.idHex){ activeNet = BASE_MAIN; setNetPillConnected(BASE_MAIN); $('lastTx').textContent='View on Basescan'; $('lastTx').href = BASE_MAIN.explorer; }
    else if (chainId === BASE_SEP.idHex){ activeNet = BASE_SEP; setNetPillConnected(BASE_SEP); $('lastTx').textContent='View on Basescan'; $('lastTx').href = BASE_SEP.explorer; }
    else { activeNet = { name:'Unknown Network', idHex:chainId }; setNetPillWarn('âš  Different network detected'); }
  }catch(_){ setNetPillWarn('Network: â€”'); }
}

async function ensureTargetSepolia(){
  if (!window.ethereum) { alert('MetaMask not found'); throw new Error('no wallet'); }
  const switchBtn = $('switch'); if (switchBtn) { switchBtn.classList.add('pulse'); setTimeout(()=>switchBtn.classList.remove('pulse'),500); }
  const chainId = await window.ethereum.request({ method:'eth_chainId' });
  if (chainId !== BASE_SEP.idHex){
    try {
      await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BASE_SEP.idHex }] });
      setNetPillConnected(BASE_SEP); toast('Switched to Base Sepolia');
      activeNet = BASE_SEP;
    } catch(e){
      if (e.code===4902){
        await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{ chainId: BASE_SEP.idHex, chainName:'Base Sepolia', nativeCurrency:{name:'ETH',symbol:'ETH',decimals:18}, rpcUrls:[BASE_SEP.rpc], blockExplorerUrls:[BASE_SEP.explorer] }] });
        setNetPillConnected(BASE_SEP); toast('Base Sepolia added'); activeNet = BASE_SEP;
      } else { throw e; }
    }
  } else { setNetPillConnected(BASE_SEP); toast('Already on Base Sepolia'); activeNet = BASE_SEP; }
}

async function connect(){
  try{
    await detectNetworkUI();
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = await provider.getSigner();
    setState('Connected');
    const connectBtn = $('connect'); if (connectBtn) connectBtn.classList.add('btn-connected');
    await refreshBetStatus();
  }catch(e){
    $('sbState').textContent = 'â€”';
  }
}
if (window.ethereum){
  window.ethereum.on?.('chainChanged', async (cid)=>{
    await detectNetworkUI();
  });
}

/* -------- Contract -------- */
async function getContract(){
  if (!signer) await connect();
  const ABI = [
    {type:'function',stateMutability:'payable',name:'createBet',inputs:[{name:'stakeWei',type:'uint256'},{name:'feeBps',type:'uint16'},{name:'joinWindowSeconds',type:'uint64'},{name:'resolveWindowSeconds',type:'uint64'}],outputs:[{name:'betId',type:'uint256'}]},
    {type:'function',stateMutability:'payable',name:'joinBet',inputs:[{name:'betId',type:'uint256'}],outputs:[]},
    {type:'function',stateMutability:'nonpayable',name:'confirmWinner',inputs:[{name:'betId',type:'uint256'},{name:'creatorWon',type:'bool'}],outputs:[]},
    {type:'function',stateMutability:'nonpayable',name:'refund',inputs:[{name:'betId',type:'uint256'}],outputs:[]},
    {type:'function',stateMutability:'nonpayable',name:'resolve',inputs:[{name:'betId',type:'uint256'}],outputs:[]},
    {type:'function',stateMutability:'view',name:'getBet',inputs:[{name:'betId',type:'uint256'}],outputs:[{type:'address'},{type:'address'},{type:'uint256'},{type:'uint16'},{type:'uint64'},{type:'uint64'},{type:'uint64'},{type:'uint8'},{type:'int8'},{type:'int8'}]}
  ];
  return new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
}

/* -------- Status helpers -------- */
function humanError(msg){ const el=$('actionStatus') || $('createStatus'); if (el) el.textContent = 'âŒ ' + msg; }
async function readBetStatus(betId, c){
  const b = await c.getBet(betId);
  const creator=b[0], opponent=b[1], stakeWei=b[2], feeBps=Number(b[3]), state=Number(b[7]), cVote=Number(b[8]), oVote=Number(b[9]);
  const joined = opponent && opponent !== ethers.ZeroAddress;
  const votesMatch = (cVote === oVote) && (cVote !== 0);
  return { creator, opponent, stakeWei, feeBps, state, cVote, oVote, joined, votesMatch };
}
async function refreshBetStatus(){
  try{
    const betIdStr = ($('betId').value||'').trim();
    if (!betIdStr) { $('betStatus').textContent = 'Status: â€”'; $('btnResolve').disabled = true; return; }
    const betId = BigInt(betIdStr);
    const c = await getContract();
    const info = await readBetStatus(betId, c);
    const stakeEth = Number(ethers.formatEther(info.stakeWei));
    let label = `Stake ${stakeEth.toFixed(4)} ETH â€¢ ` + (info.joined ? 'Joined' : 'Open');
    if (info.votesMatch) label += ' â€¢ Votes match';
    if (info.state === 2) label += ' â€¢ Resolved';
    if (info.state === 3) label += ' â€¢ Refunded';
    $('betStatus').textContent = 'Status: ' + label;
    if (info.state === 2 || info.state === 3) {
      $('resolveNote').textContent = 'This bet is closed. Ask the creator to share a new link.';
      $('btnJoin').disabled = true;
      ['creatorWon','creatorSaysOpponent','opponentSaysCreator','opponentWon'].forEach(id=>{ const b=$(`${id}`); if(b) b.disabled=true; });
    } else {
      $('resolveNote').textContent = 'Waiting for both votesâ€¦';
      $('btnJoin').disabled = false;
      ['creatorWon','creatorSaysOpponent','opponentSaysCreator','opponentWon'].forEach(id=>{ const b=$(`${id}`); if(b) b.disabled=false; });
    }
    $('btnResolve').disabled = !(info.joined && info.votesMatch && info.state !== 2);
  }catch(e){
    $('betStatus').textContent = 'Status: (read error)';
    $('btnResolve').disabled = true;
  }
}

/* -------- Actions -------- */
async function onCreate(){
  const createBtn = $('btnCreate');
  $('createStatus').textContent='Sendingâ€¦';
  highlight(createBtn);
  try{
    const c = await getContract();
    const stakeEth = String($('stake').value||'0');
    const jm = Math.max(5,  Math.min(43200, parseInt($('joinMins').value||'15',10)));
    const rm = Math.max(30, Math.min(43200, parseInt($('resolveMins').value||'30',10)));
    $('joinMins').value = jm; $('resolveMins').value = rm;
    const stakeWei = ethers.parseEther(stakeEth);
    let predictedId = null; try{ predictedId = await c.createBet.staticCall(stakeWei, 250, BigInt(jm*60), BigInt(rm*60), { value: stakeWei }); }catch(_){}
    const tx = await c.createBet(stakeWei, 250, BigInt(jm*60), BigInt(rm*60), { value: stakeWei });
    $('createStatus').textContent = 'Pending ' + tx.hash;
    const rc = await tx.wait();
    $('lastTx').href = (activeNet?.explorer || BASE_SEP.explorer) + '/tx/' + tx.hash;
    if (predictedId !== null && predictedId !== undefined){ setBetId(predictedId.toString()); try{ localStorage.setItem('lastCreatedBetId', String(predictedId)); }catch(_){} } else { ensureShareDefaults(); }
    $('createStatus').textContent = 'âœ… Created (check explorer)';
    setState('Connected â€¢ Created');
    createBtn.classList.add('btn-connected'); // keep green after create
    await refreshBetStatus();
  }catch(e){
    $('createStatus').textContent = 'âŒ ' + (e?.shortMessage||e?.message||e);
    ensureShareDefaults();
  }
}

async function onJoin(){
  $('actionStatus').textContent='Sendingâ€¦';
  try{
    const c = await getContract();
    const betIdStr = ($('betId').value||'').trim();
    if (!betIdStr) return humanError('Enter or open a bet link first.');
    const betId = BigInt(betIdStr);
    const info = await readBetStatus(betId, c);
    if (info.state === 2) return humanError('Bet is already resolved.');
    if (info.state === 3) return humanError('Bet was refunded/cancelled.');
    if (info.joined)      return humanError('Bet already has an opponent.');
    const tx = await c.joinBet(betId, { value: info.stakeWei });
    const rc = await tx.wait();
    $('lastTx').href = (activeNet?.explorer || BASE_SEP.explorer) + '/tx/' + tx.hash;
    $('actionStatus').textContent = 'âœ… Joined bet #' + betId;
    await refreshBetStatus();
  }catch(e){ humanError(e?.shortMessage||e?.message||'Join failed'); }
}

async function onVote(creatorWon){
  $('actionStatus').textContent='Sendingâ€¦';
  try{
    const betIdStr = ($('betId').value||'').trim(); if (!betIdStr) return humanError('Open a bet link first.');
    const betId = BigInt(betIdStr);
    const c = await getContract();
    const info = await readBetStatus(betId, c); if (info.state === 2) return humanError('Already resolved.');
    const tx = await c.confirmWinner(betId, Boolean(creatorWon));
    const rc = await tx.wait();
    $('lastTx').href = (activeNet?.explorer || BASE_SEP.explorer) + '/tx/' + tx.hash;
    $('actionStatus').textContent = 'âœ… Vote submitted';
    await refreshBetStatus();
  }catch(e){ humanError(e?.shortMessage||e?.message||'Vote failed'); }
}

async function onResolve(){
  $('actionStatus').textContent='Sendingâ€¦';
  try{
    const betIdStr = ($('betId').value||'').trim(); if (!betIdStr) return humanError('Open a bet link first.');
    const betId = BigInt(betIdStr);
    const c = await getContract();
    const info = await readBetStatus(betId, c);
    if (!info.joined) return humanError('Cannot resolve: no opponent.');
    if (!info.votesMatch) return humanError('Both votes must match to resolve.');
    const tx = await c.resolve(betId);
    const rc = await tx.wait();
    $('lastTx').href = (activeNet?.explorer || BASE_SEP.explorer) + '/tx/' + tx.hash;
    $('actionStatus').textContent = 'âœ… Resolved & paid (check explorer)';
    await refreshBetStatus();
  }catch(e){ humanError(e?.shortMessage||e?.message||'Resolve failed'); }
}

async function onRefund(){
  $('actionStatus').textContent='Sendingâ€¦';
  try{
    const c = await getContract();
    const betIdStr = ($('betId').value||'').trim(); if (!betIdStr) return humanError('Open a bet link first.');
    const betId = BigInt(betIdStr);
    const tx = await c.refund(betId);
    const rc = await tx.wait();
    $('lastTx').href = (activeNet?.explorer || BASE_SEP.explorer) + '/tx/' + tx.hash;
    $('actionStatus').textContent = 'âœ… Refund sent';
    await refreshBetStatus();
  }catch(e){ humanError(e?.shortMessage||e?.message||'Refund failed'); }
}

/* -------- Wire UI -------- */
window.addEventListener('DOMContentLoaded', async ()=>{
  // Set contract field + copy
  const addrInput = $('contractAddr'); if (addrInput) addrInput.value = CONTRACT_ADDRESS;
  const copyContractBtn = $('copyContract'); if (copyContractBtn) copyContractBtn.onclick = async () => { try { await navigator.clipboard.writeText(CONTRACT_ADDRESS); toast('Contract copied'); highlight(copyContractBtn); } catch(_){} };

  $('connect').onclick = connect;
  $('switch').onclick  = ensureTargetSepolia;
  $('newBet').onclick  = ()=>{ clearBetFromUrl(); $('betId').value = ''; $('createStatus').textContent = ''; $('actionStatus').textContent = ''; $('betStatus').textContent = 'Status: â€”'; $('stakeUsdInput').value='5'; syncEthFromUsd(); };

  // Default $5 â†’ ETH preview
  syncEthFromUsd();
  $('stake').addEventListener('input', syncUsdFromEth);
  $('stakeUsdInput').addEventListener('input', syncEthFromUsd);
  $('q1').onclick  = ()=>{ $('stakeUsdInput').value=1;  syncEthFromUsd(); };
  $('q5').onclick  = ()=>{ $('stakeUsdInput').value=5;  syncEthFromUsd(); };
  $('q20').onclick = ()=>{ $('stakeUsdInput').value=20; syncEthFromUsd(); };
  $('stakePlus').onclick = ()=>{ const v=parseFloat($('stake').value||'0')+0.0001; $('stake').value=v.toFixed(4); syncUsdFromEth(); };
  $('stakeMinus').onclick= ()=>{ const v=Math.max(0, parseFloat($('stake').value||'0')-0.0001); $('stake').value=v.toFixed(4); syncUsdFromEth(); };

  $('btnCreate').onclick = onCreate;
  $('btnReset').onclick  = ()=>{ $('stakeUsdInput').value='5'; syncEthFromUsd(); $('joinMins').value='15'; $('resolveMins').value='30'; };
  $('btnJoin').onclick   = onJoin;
  $('btnRefund').onclick = onRefund;
  $('btnResolve').onclick= onResolve;
  $('creatorWon').onclick= ()=>onVote(true);
  $('creatorSaysOpponent').onclick= ()=>onVote(false);
  $('opponentSaysCreator').onclick= ()=>onVote(true);
  $('opponentWon').onclick= ()=>onVote(false);

  await detectNetworkUI(); // show current network on load
});
</script>
</body>
</html>
