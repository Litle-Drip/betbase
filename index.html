<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The Juice ‚Äî Crypto Escrow Bets</title>

<!-- Styles -->
<style>
  :root{
    --bg:#0b1220;
    --card:#111a2b;
    --text:#e7eaf0;
    --muted:#9aa6b2;
    --border:#22314d;
    --accent:#22c55e;
    --accent-ink:#052e16;
    --chip:#0d1627;
    --radius:16px;
    --space:14px;
    --fs:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:linear-gradient(180deg,#0b1220,#0a0f1a);
    color:var(--text);
    font:600 var(--fs)/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  .container{max-width:1200px;margin:22px auto;padding:0 16px}
  .header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px}
  .title{font-size:28px;font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#062216;border:1px solid var(--accent);
        color:#a7f3d0;padding:6px 10px;border-radius:999px;font-size:12px}
  .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1}
  .chip.success{background:var(--accent-ink);border-color:var(--accent);color:#a7f3d0}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .addr{background:#0d1627;border:1px solid var(--border);border-radius:10px;padding:10px 12px;min-width:0;
        font-family:ui-monospace,Menlo,Consolas,monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#0f172a;color:#dfe7ef;
       cursor:pointer;transition:transform .06s ease, box-shadow .12s ease, background .12s ease}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:var(--accent-ink);font-weight:800}
  .btn.ghost{background:#0f172a;border-color:var(--accent);color:#a7f3d0}
  .btn.connected{background:var(--accent);color:var(--accent-ink);border-color:var(--accent)}
  .btn.small{padding:7px 10px;font-size:13px;border-radius:10px}
  /* Bigger - and + buttons only */
#ethMinus,
#ethPlus{
  padding:14px 18px;
  font-size:16px;
  border-radius:10px;
  border-color: var(--accent);
  color: var(--accent);
  background: transparent;
}

#ethMinus:active,
#ethPlus:active{
  background: var(--accent);
  color: var(--accent-ink);
}
  .grid{display:grid;gap:16px}
  @media(min-width:960px){.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;
        box-shadow:0 6px 18px rgba(0,0,0,.25)}
  h3{margin:0 0 10px 0;font-size:20px}
  .label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .input{width:100%;padding:12px 12px;border:1px solid var(--border);border-radius:12px;background:#0b1324;color:var(--text)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .help{font-size:12px;color:var(--muted)}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .state{background:#0b1324;border:1px solid var(--border);border-radius:12px;padding:6px 10px;color:#cbd5e1}
  .state.ok{background:var(--accent-ink);border-color:var(--accent);color:#a7f3d0}
  .voteWrap{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
  .voteBox{border:1px solid var(--border);border-radius:14px;padding:12px}
  .voteTitle{font-weight:800;margin:0 0 8px 0;text-align:center}
  /* QR box */
  #qrBox{border:1px dashed var(--border);border-radius:12px;padding:10px;background:#0b1324;display:flex;
         align-items:center;justify-content:center;min-width:156px;min-height:156px}
  /* sticky footer summary */
  .sticky{position:sticky;bottom:0;background:rgba(11,19,36,.9);backdrop-filter:blur(6px);
          border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:14px}
  .spacer{height:8px}
  .successNote{display:flex;align-items:center;gap:8px;font-size:13px;color:#a7f3d0}
  .btnConnected {
  border-color: var(--accent);
  color: var(--accent);
}
</style>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="title">üßÉ <span>The Juice ‚Äî Crypto Escrow Bets</span></div>
      <div class="toolbar">
        <div class="addr" id="addrPill" title="Escrow contract address (locked)"></div>
        <button id="btnConnect" class="btn ghost">Connect Wallet</button>
        <button id="btnSwitch" class="btn ghost">Switch to Base Sepolia</button>
        <button id="btnNewBet" class="btn ghost">Start New Bet</button>
      </div>
      <div class="row">
        <span class="pill">Base ‚Ä¢ Sepolia ‚Ä¢ (84532)</span>
        <span class="chip">No bookie. Just code.</span>
      </div>
    </div>

    <p class="help">Create a bet, your friend joins and matches the stake, you both confirm the winner, then payout. Refunds are fee-free if deadlines pass.</p>

    <div class="grid grid-3">
      <!-- Create -->
      <div class="card">
        <h3 style="text-align:center">Create Bet</h3>

                <div class="row" style="align-items:flex-end">
          <div style="min-width:220px;flex:1">
            <label class="label">
              Stake (<span id="stakeModeLabel">ETH</span>)
            </label>
            <input id="stakeMain" class="input" type="number" step="0.0001" value="0.0014"/>
          </div>

          <div class="row" style="align-items:center;gap:6px">
            <button id="stakeModeUsd" class="btn small ghost">USD</button>
            <button id="stakeModeEth" class="btn small ghost">ETH</button>
            <button id="ethMinus" class="btn small ghost">‚àí</button>
            <button id="ethPlus"  class="btn small ghost">+</button>
          </div>

          <!-- hidden fields that the JS and contract still use -->
          <input id="stakeEth" class="input" type="hidden" value="0.0014"/>
          <input id="stakeUsd" class="input" type="hidden" value="5"/>
        </div>

        <div class="row" style="margin-top:6px">
        <span class="label" style="margin:0">Set by USD:</span>
          <button class="btn small ghost" id="usd1">$1</button>
          <button class="btn small ghost" id="usd5">$5</button>
          <button class="btn small ghost" id="usd20">$20</button>
          <span class="label" style="margin:0 0 0 8px">Custom</span>
        </div>

        <div class="spacer"></div>
        <label class="label">Fee (fixed at 2.5%)</label>
        <input id="feeBps" class="input" value="250" readonly disabled/>

        <div class="spacer"></div>
        <label class="label">Join deadline (minutes) <span class="help">(5‚Äì43200)</span></label>
        <input id="joinMins" class="input" type="number" min="5" max="43200" value="15"/>

        <div class="spacer"></div>
        <label class="label">Resolve deadline (minutes) <span class="help">(30‚Äì43200)</span></label>
        <input id="resolveMins" class="input" type="number" min="30" max="43200" value="30"/>

        <div class="spacer"></div>
        <label class="label">Preview ETH/USD price <span class="help">(used for display only)</span></label>
        <div class="row">
          <input id="ethUsd" class="input" type="number" min="50" max="100000" value="3500" style="max-width:200px"/>
          <button id="btnSetEthUsd" class="btn small ghost">Update preview</button>
        </div>
        <div class="help" id="ethUsdNote">Static price ‚Äî adjust if market moves.</div>

        <div class="spacer"></div>
        <div class="row">
          <button id="btnCreate" class="btn ghost">Create & Fund</button>
          <button id="btnReset" class="btn">Reset</button>
        </div>
        <div id="createStatus" class="help" style="margin-top:8px"></div>
      </div>

      <!-- Join / Resolve -->
      <div class="card">
        <h3 style="text-align:center">Join / Resolve</h3>
        <div class="help" id="resolveNote" style="margin:6px 0 12px;text-align:center">Waiting for both votes‚Ä¶</div>

        <div class="row" style="margin-bottom:10px">
          <button id="btnJoin" class="btn ghost" style="width:100%">Join & Match Stake</button>
          <button id="btnRefund" class="btn ghost" style="width:100%">Request Refund</button>
        </div>

        <button id="btnPayout" class="btn ghost" style="width:100%;margin-bottom:10px">Payout ‚Äî Finalize Bet!</button>

        <div class="voteWrap">
          <div class="voteBox">
            <p class="voteTitle">Creator vote</p>
            <div class="row">
              <button id="creatorWon" class="btn ghost" style="width:100%">Creator won</button>
              <button id="creatorSaysOpponent" class="btn ghost" style="width:100%">Opponent won</button>
            </div>
          </div>
          <div class="voteBox">
            <p class="voteTitle">Opponent vote</p>
            <div class="row">
              <button id="opponentSaysCreator" class="btn ghost" style="width:100%">Creator won</button>
              <button id="opponentWon" class="btn ghost" style="width:100%">Opponent won</button>
            </div>
          </div>
        </div>

        <div id="actionStatus" class="help" style="margin-top:10px"></div>
        <div id="newBetNote" class="successNote" style="display:none;margin-top:10px;justify-content:center;text-align:center">üÜï New bet link prepared ‚Äî share the QR!</div>

        <div class="spacer"></div>
        <h4 style="margin:6px 0">Bet details</h4>
        <div class="help" id="betSummary">Enter a bet ID to load details.</div>
        <div class="row" style="margin-top:8px">
          <div class="state" id="betState">No bet loaded</div>
          <button id="btnLoadBet" class="btn small ghost">Load bet</button>
        </div>
        <div class="help" id="betMeta"></div>
      </div>

      <!-- Share / QR + Bet Ideas -->
      <div class="card">
        <h3 style="text-align:center">Share / QR</h3>
        <div class="help" style="white-space:nowrap">Show this to your opponent so they can open the exact bet.</div>
        <div class="row" style="margin-top:8px">
          <input id="betId" class="input" style="width:140px" value=""/>
          <button id="btnCopy" class="btn small ghost btnConnected" style="height:100%;padding:12px 16px">Copy link</button>
          <input id="shareUrl" class="input" style="flex:1 1 100%" readonly/>
        </div>
        <div class="help" id="shareNote" style="margin-top:4px">Bet link will populate after creation.</div>
        <div id="qrBox" style="margin-top:10px"></div>

        <div class="spacer"></div>
        <h3 style="margin-top:16px;text-align:center">Bet Ideas</h3>
        <div class="help" style="white-space:nowrap;text-align:center">Tap shuffle to get a quick ideas you can use IRL!</div>
        <div class="row" style="margin-top:8px">
          <input id="ideaBox" class="input" readonly value="Make a 3-point shot from the top of the key"/>
          <button id="btnShuffle" class="btn small ghost">Shuffle</button>
        </div>
      </div>
    </div>

    <!-- Sticky summary -->
    <div class="sticky">
      <div class="kpi">
        <div class="state" id="sbState">‚Äî</div>
        <div class="chip">Fee: <strong style="margin-left:6px">2.5%</strong></div>
        <div class="chip">Pot: <strong><span id="sbPotEth">0.0000</span> ETH</strong> (<span id="sbPotUsd">$0.00</span>)</div>
        <div class="chip">Winner gets: <strong><span id="sbWinEth">0.0000</span> ETH</strong> (<span id="sbWinUsd">$0.00</span>)</div>
        <a id="lastTx" class="chip" href="#" target="_blank" style="text-decoration:underline">View on Basescan</a>
      </div>
    </div>
  </div>

<script>
/* ---------- Config ---------- */
const BASE = { idHex: '0x14a34', rpc: 'https://sepolia.base.org', explorer: 'https://sepolia.basescan.org' };
const FEE_BPS = 250;        // fixed 2.5%
let   ETH_USD = 3500;       // preview only
const CONTRACT_ADDRESS = '0xD251F4aFB44Fa54Af8E714C8219d5a535Bc59433'; // UPDATED (Base Sepolia Verified)
const STATUS = Object.freeze({
  0:'Pending join',
  1:'Active',
  2:'Resolved',
  3:'Refunded'
});

/* ---------- Shortcuts ---------- */
const $ = id => document.getElementById(id);
const fmtUsd = v => '$' + v.toFixed(2);

/* ---------- Fill header contract pill ---------- */
$('addrPill').textContent = `Contract: ${CONTRACT_ADDRESS}`;

/* ---------- QR + share helpers ---------- */
function currentShareUrl() {
  const betId = $('betId').value;
  try {
    const u = new URL(location.href);
    if (betId) {
      // If we have a betId, include it in the URL
      u.searchParams.set('bet', betId);
    } else {
      // If no betId yet, don‚Äôt show a fake one
      u.searchParams.delete('bet');
    }
    return u.toString();
  } catch {
    return location.href;
  }
}
let qr = null;
function renderQR() {
  const node = $('qrBox'); node.innerHTML = '';
  qr = new QRCode(node, { text: currentShareUrl(), width: 160, height: 160, colorDark:'#ffffff', colorLight:'#0b1324', correctLevel: QRCode.CorrectLevel.M });
}
function clearShare(){
  $('betId').value = '';
  $('shareUrl').value = currentShareUrl();
  $('shareNote').textContent = 'Bet link will populate after creation.';
  $('qrBox').innerHTML = '';
  $('newBetNote').style.display = 'none';
}
function setCopyPulse(el){
  el.classList.add('connected');
  setTimeout(()=>el.classList.remove('connected'), 800);
}

/* ---------- USD/ETH preview ---------- */
function updatePreview() {
  const eth = parseFloat($('stakeEth').value || '0') || 0;
  const pot = eth * 2;
  const win = pot * (1 - FEE_BPS / 10000);

  const potEthEl = $('sbPotEth');
  if (potEthEl) potEthEl.textContent = pot.toFixed(4);

  const potUsdEl = $('sbPotUsd');
  if (potUsdEl) potUsdEl.textContent = fmtUsd(pot * ETH_USD);

  const winEthEl = $('sbWinEth');
  if (winEthEl) winEthEl.textContent = win.toFixed(4);

  const winUsdEl = $('sbWinUsd');
  if (winUsdEl) winUsdEl.textContent = fmtUsd(win * ETH_USD);

  const usdPrevEl = $('usdPreview');
  if (usdPrevEl) usdPrevEl.textContent = '‚âà ' + fmtUsd(eth * ETH_USD);
}
function syncUsdFromEth(){ $('stakeUsd').value = (parseFloat($('stakeEth').value||'0')*ETH_USD).toFixed(0); updatePreview(); }
function syncEthFromUsd(){ $('stakeEth').value = (parseFloat($('stakeUsd').value||'0')/ETH_USD).toFixed(4); updatePreview(); }
// ---------- Single stake box + mode toggle ----------
let stakeMode = 'ETH'; // or 'USD'

// Core function: whenever ETH changes, update hidden fields, visible box, and preview
function applyStakeFromEth(rawEth) {
  const eth = Math.max(0, Number(rawEth) || 0);

  // hidden ETH + USD
  $('stakeEth').value = eth.toFixed(4);
  $('stakeUsd').value = (eth * ETH_USD).toFixed(0);

  if (stakeMode === 'ETH') {
    $('stakeMain').value = eth.toFixed(4);
  } else {
    $('stakeMain').value = (eth * ETH_USD).toFixed(0);
  }

  updatePreview();
}

// When user types in the single box
function handleStakeMainInput() {
  const num = Number($('stakeMain').value) || 0;
  if (stakeMode === 'ETH') {
    applyStakeFromEth(num);
  } else {
    const eth = num / ETH_USD;
    applyStakeFromEth(eth);
  }
}

// Switch between ETH and USD modes
function setStakeMode(mode) {
  if (mode !== 'ETH' && mode !== 'USD') return;
  stakeMode = mode;

  // Label
  const lbl = $('stakeModeLabel');
  if (lbl) lbl.textContent = mode;

  // Simple visual state on buttons
  $('stakeModeEth').classList.toggle('connected', mode === 'ETH');
  $('stakeModeUsd').classList.toggle('connected', mode === 'USD');

  const eth = parseFloat($('stakeEth').value || '0') || 0;

  if (mode === 'ETH') {
    $('stakeMain').step = '0.0001';
    $('stakeMain').value = eth.toFixed(4);
  } else {
    $('stakeMain').step = '1';
    $('stakeMain').value = (eth * ETH_USD).toFixed(0);
  }
}

/* ---------- Wallet / ethers ---------- */
let provider, signer;
const ABI = [
  {type:'function',stateMutability:'payable',   name:'createBet',   inputs:[{name:'stakeWei',type:'uint256'},{name:'feeBps',type:'uint16'},{name:'joinWindowSeconds',type:'uint64'},{name:'resolveWindowSeconds',type:'uint64'}], outputs:[{name:'betId',type:'uint256'}]},
  {type:'function',stateMutability:'payable',   name:'joinBet',     inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'confirmWinner',inputs:[{name:'betId',type:'uint256'},{name:'creatorWon',type:'bool'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'refund',      inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'resolve',     inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'view',      name:'getBet',      inputs:[{name:'betId',type:'uint256'}], outputs:[{type:'address'},{type:'address'},{type:'uint256'},{type:'uint16'},{type:'uint64'},{type:'uint64'},{type:'uint64'},{type:'uint8'},{type:'int8'},{type:'int8'}]},
  {type:'function',stateMutability:'view',      name:'nextBetId',   inputs:[], outputs:[{type:'uint256'}]}
];
async function ensureBase(){
  if (!window.ethereum) { alert('MetaMask not found'); throw new Error('no wallet'); }
  const chain = await window.ethereum.request({ method:'eth_chainId' });
  if (chain !== BASE.idHex){
    try{
      await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BASE.idHex }] });
    }catch(e){
      if (e.code === 4902){
        await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{ chainId: BASE.idHex, chainName:'Base Sepolia', nativeCurrency:{name:'ETH',symbol:'ETH',decimals:18}, rpcUrls:[BASE.rpc], blockExplorerUrls:[BASE.explorer]}] });
      } else { throw e; }
    }
  }
}
async function connect(){
  try{
    await ensureBase();
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts',[]);
    signer = await provider.getSigner();
    $('sbState').textContent = 'Connected';
    $('sbState').classList.add('ok');
    $('btnConnect').classList.add('connected');
  }catch(e){
    $('sbState').textContent = '‚Äî';
    $('sbState').classList.remove('ok');
  }
}
function getContract(){
  if (!signer) throw new Error('Connect your wallet first.');
  return new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
}

function requireBetId(){
  const raw = String(($('betId').value || '').trim());
  if (!raw) throw new Error('Enter a bet ID first.');
  if (!/^\d+$/.test(raw)) throw new Error('Bet ID must be a number.');
  return BigInt(raw);
}
function renderBetMeta(bet){
  if (!bet){
    $('betSummary').textContent = 'Enter a bet ID to load details.';
    $('betState').textContent = 'No bet loaded';
    $('betState').classList.remove('ok');
    $('betMeta').textContent = '';
    return;
  }
  const statusText = STATUS[bet.status] ?? `Status ${bet.status}`;
  $('betState').textContent = statusText;
  if (bet.status === 1 || bet.status === 2) $('betState').classList.add('ok'); else $('betState').classList.remove('ok');
  const parts = [
    `Creator: ${bet.creator}`,
    `Opponent: ${bet.opponent === ethers.ZeroAddress ? '‚Äî (open)' : bet.opponent}`,
    `Stake: ${ethers.formatEther(bet.stakeWei)} ETH`,
    `Fee: ${(bet.feeBps/100).toFixed(2)}%`,
    `Join by: ${bet.joinDeadline ? new Date(Number(bet.joinDeadline)*1000).toLocaleString() : 'n/a'}`,
    `Resolve by: ${bet.resolveDeadline ? new Date(Number(bet.resolveDeadline)*1000).toLocaleString() : 'n/a'}`,
    `Last action: ${bet.lastAction ? new Date(Number(bet.lastAction)*1000).toLocaleString() : 'n/a'}`,
    `Votes (creator/opponent): ${bet.creatorVote} / ${bet.opponentVote}`
  ];
  $('betSummary').textContent = `Bet #${bet.betId} loaded.`;
  $('betMeta').textContent = parts.join(' ‚Ä¢ ');
}
async function loadBetDetails(){
  try{
    const betId = requireBetId();
    if (!signer) await connect();
    const c = getContract();
    const res = await c.getBet(betId);
    if (!res || res[0] === ethers.ZeroAddress){ throw new Error('Bet not found on-chain.'); }
    const bet = {
      betId: betId.toString(),
      creator: res[0],
      opponent: res[1],
      stakeWei: res[2],
      feeBps: Number(res[3]),
      joinDeadline: res[4],
      resolveDeadline: res[5],
      lastAction: res[6],
      status: Number(res[7] ?? 0),
      creatorVote: Number(res[8] ?? 0),
      opponentVote: Number(res[9] ?? 0)
    };
    renderBetMeta(bet);
    return bet;
  }catch(e){
    $('actionStatus').textContent = '‚ùå ' + (e?.shortMessage||e?.message||e);
    renderBetMeta(null);
    throw e;
  }
}

/* ---------- Actions ---------- */
async function doCreate(){
  $('createStatus').textContent = 'Sending‚Ä¶';
  try{
    if (!signer) await connect();
    const c = getContract();
    const stakeEth = String($('stakeEth').value || '0');

    if (Number(stakeEth) <= 0){
      throw new Error('Stake must be greater than zero.');
    }

    // clamp minutes
    const jm = Math.max(5,  Math.min(43200, parseInt($('joinMins').value || '15', 10)));
    const rm = Math.max(30, Math.min(43200, parseInt($('resolveMins').value || '30', 10)));
    $('joinMins').value = jm; $('resolveMins').value = rm;

    const stakeWei = ethers.parseEther(stakeEth);

    // ‚úÖ call 4-arg signature (includes feeBps)
    const tx = await c.createBet(
      stakeWei,
      FEE_BPS,                 // 250
      BigInt(jm * 60),
      BigInt(rm * 60),
      { value: stakeWei }
    );
    $('createStatus').textContent = 'Pending ' + tx.hash;

    const rc = await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('createStatus').textContent = '‚úÖ Created (check explorer)';

    // ‚úÖ NEW: pull the real on-chain betId and update UI / link / QR
    const nextId = await c.nextBetId();              // e.g. 12
    const betId  = (BigInt(nextId) - 1n).toString(); // last created = nextBetId - 1
    $('betId').value = betId;
    $('shareUrl').value = currentShareUrl();
    renderQR();

    $('btnCreate').classList.add('connected');
    $('newBetNote').style.display = 'flex';
    $('shareNote').textContent = 'This bet ID is on-chain. Share the link or QR.';
    await loadBetDetails();
  }catch(e){
    console.error('createBet error', e);
    $('createStatus').textContent = '‚ùå ' + (e?.shortMessage||e?.message||e);
  }
}

async function doJoin(){
  $('actionStatus').textContent = 'Sending‚Ä¶';
  try{
    if (!signer) await connect();
    const c = getContract();
    const bet = await loadBetDetails();
    const now = Math.floor(Date.now()/1000);
    if (bet.opponent !== ethers.ZeroAddress){ throw new Error('This bet already has an opponent.'); }
    if (bet.joinDeadline && now > Number(bet.joinDeadline)){ throw new Error('Join window has ended.'); }
    if (!bet.stakeWei || bet.stakeWei === 0n){ throw new Error('Bet not initialized on-chain.'); }
    const tx = await c.joinBet(bet.betId, { value: bet.stakeWei });
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Joined bet #' + bet.betId;
  }catch(e){
    $('actionStatus').textContent = '‚ùå ' + (e?.shortMessage||e?.message||e);
  }
}
async function doVote(creatorWon){
  $('actionStatus').textContent = 'Sending‚Ä¶';
  try{
    if (!signer) await connect();
    const c = getContract();
    const bet = await loadBetDetails();
    const addr = await signer.getAddress();
    if (bet.opponent === ethers.ZeroAddress){ throw new Error('Opponent not joined yet.'); }
    if (bet.status === 2 || bet.status === 3){ throw new Error('Bet already finalized.'); }
    if (addr.toLowerCase() !== bet.creator.toLowerCase() && addr.toLowerCase() !== bet.opponent.toLowerCase()){
      throw new Error('Only creator or opponent can vote.');
    }
    const tx = await c.confirmWinner(bet.betId, Boolean(creatorWon));
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Vote submitted';
  }catch(e){
    $('actionStatus').textContent = '‚ùå ' + (e?.shortMessage||e?.message||e);
  }
}
async function doRefund(){
  $('actionStatus').textContent = 'Sending‚Ä¶';
  try{
    if (!signer) await connect();
    const c = getContract();
    const bet = await loadBetDetails();
    const addr = await signer.getAddress();
    const now = Math.floor(Date.now()/1000);
    if (addr.toLowerCase() !== bet.creator.toLowerCase() && addr.toLowerCase() !== bet.opponent.toLowerCase()){
      throw new Error('Only participants can request a refund.');
    }
    if (bet.opponent !== ethers.ZeroAddress && bet.resolveDeadline && now < Number(bet.resolveDeadline)){
      throw new Error('Resolve window still active; refund may revert.');
    }
    const tx = await c.refund(bet.betId);
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Refund sent';
  }catch(e){
    $('actionStatus').textContent = '‚ùå ' + (e?.shortMessage||e?.message||e);
  }
}
async function doPayout(){
  $('actionStatus').textContent = 'Sending‚Ä¶';
  try{
    if (!signer) await connect();
    const c = getContract();
    const bet = await loadBetDetails();
    if (bet.creatorVote === 0 || bet.opponentVote === 0){ throw new Error('Both votes are required before payout.'); }
    const tx = await c.resolve(bet.betId);
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Payout finalized';
  }catch(e){
    $('actionStatus').textContent = '‚ùå ' + (e?.shortMessage||e?.message||e);
  }
}

/* ---------- Bet Ideas ---------- */
const IDEAS = [
  "Make a 3-point shot from the top of the key",
  "Darts: Hit any double in 3 throws",
  "Darts: You vs Me",
  "Darts: Bullzeye",
  "Drink: Chug under 1 minute",
  "Hockey: Hitthe crossbar",
  "Lacrosse: Top right corner",
  "Human: No way!",
  "Human: I bet you can't",
  "Cornhole: 2 in a row",
  "Bottle Flip: 3 out of 5",
  "Soccer: Crossbar in 3 tries",
  "Golf: Hole in one!",
  "Golf: 3-putt?",
  "Golf: 2-putt of better",
  "Golf: Green-in-regulation?",
  "Golf: Fairway off the tee",
  "Gaming: 1 V 1",
  "Speed: I'll bet you there!",
  "Pool: You vs Me",
  "Soccer: Crossbar in 3 tries",
  "Pool: Bank shot within 2 tries",
  "Golf: Closest-to-the-pin",
  "Golf: On the green?",
  "Golf: Low score",
  "Golf: Match Play",
  "Ping pong: Serve an ace in 5 serves"
];
function shuffleIdea(){
  $('ideaBox').value = IDEAS[Math.floor(Math.random()*IDEAS.length)];
}

/* ---------- New bet link ---------- */
function startNewBet(){
  clearShare();
  $('shareNote').textContent = 'Create & fund to receive the on-chain bet ID.';
}

/* ---------- Wire UI ---------- */
window.addEventListener('DOMContentLoaded', ()=>{
  // defaults + preview
    // defaults + preview (start in ETH mode with initial value)
  setStakeMode('ETH');
  applyStakeFromEth($('stakeEth').value || '0');

  // single stake box input
  $('stakeMain').addEventListener('input', handleStakeMainInput);

  // toggle buttons
  $('stakeModeEth').onclick = ()=> setStakeMode('ETH');
  $('stakeModeUsd').onclick = ()=> setStakeMode('USD');

  $('btnSetEthUsd').onclick = ()=>{
    const v = Number($('ethUsd').value || ETH_USD);
    if (Number.isFinite(v) && v > 0){
      ETH_USD = v;
      $('ethUsdNote').textContent = 'Preview price updated manually.';
      updatePreview();
    } else {
      $('ethUsdNote').textContent = 'Enter a valid price to update the preview.';
    }
  };

  // USD preset buttons ‚Äî interpret as USD and convert
  $('usd1').onclick  = ()=>{ setStakeMode('USD'); $('stakeMain').value = 1;  handleStakeMainInput(); };
  $('usd5').onclick  = ()=>{ setStakeMode('USD'); $('stakeMain').value = 5;  handleStakeMainInput(); };
  $('usd20').onclick = ()=>{ setStakeMode('USD'); $('stakeMain').value = 20; handleStakeMainInput(); };

  // +/- buttons ‚Äî adjust in ETH space
  $('ethPlus').onclick  = ()=>{
    const v = Math.max(0, parseFloat($('stakeEth').value || '0') + 0.0001);
    applyStakeFromEth(v);
  };
  $('ethMinus').onclick = ()=>{
    const v = Math.max(0, parseFloat($('stakeEth').value || '0') - 0.0001);
    applyStakeFromEth(v);
  };

  // share / QR
  renderQR();
  $('betId').addEventListener('input', ()=>{ $('shareUrl').value = currentShareUrl(); $('shareNote').textContent = 'Load details to validate this bet.'; renderQR(); });
  $('shareUrl').value = currentShareUrl();
  $('btnCopy').onclick = async ()=>{ try{ await navigator.clipboard.writeText($('shareUrl').value); setCopyPulse($('btnCopy')); $('shareNote').textContent = 'Copied to clipboard.'; }catch(e){ $('shareNote').textContent = 'Clipboard failed: ' + (e?.message||e); } };

  // connect + chain switch
  $('btnConnect').onclick = connect;
  $('btnSwitch').onclick  = async ()=>{
  try {
    await ensureBase();
    $('btnSwitch').classList.add('connected');
    $('actionStatus').textContent = 'Network set to Base Sepolia.';
  } catch(err){
    $('actionStatus').textContent = '‚ùå Network switch failed: ' + (err?.message||err);
  }
};

  // actions
  $('btnCreate').onclick = doCreate;
  $('btnReset').onclick  = ()=>{ $('joinMins').value='15'; $('resolveMins').value='30'; applyStakeFromEth(0.0014); clearShare(); renderBetMeta(null); };
  $('btnJoin').onclick   = doJoin;
  $('btnRefund').onclick = doRefund;
  $('creatorWon').onclick= ()=>doVote(true);
  $('creatorSaysOpponent').onclick= ()=>doVote(false);
  $('opponentSaysCreator').onclick= ()=>doVote(true);
  $('opponentWon').onclick= ()=>doVote(false);
  $('btnPayout').onclick = doPayout;
  $('btnLoadBet').onclick = loadBetDetails;

  // ideas
  $('btnShuffle').onclick = shuffleIdea;

  // new bet
  $('btnNewBet').onclick = () => {
  startNewBet();
  $('btnNewBet').classList.add('connected');
};

  // read ?bet= on load
  const p = new URLSearchParams(location.search); const b = p.get('bet'); if (b){ $('betId').value=b; $('shareUrl').value=currentShareUrl(); renderQR(); }
});
</script>
</body>
</html>
