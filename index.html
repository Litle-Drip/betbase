<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>The Juice ‚Äî Crypto Escrow Bets</title>
  <style>
    :root{
      --bg:#0b1220;--card:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2a44;
      --accent:#22c55e;--accent-ink:#052e16;--ink:#0b1324;--chip:#0b1324;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1a);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text)}
    .container{max-width:1200px;margin:20px auto;padding:0 16px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    h1{font-size:26px;margin:0}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{font-size:26px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{background:#052e16;border:1px solid #16a34a;color:#86efac;padding:4px 10px;border-radius:999px;font-size:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.25);height:100%}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .label{font-size:13px;color:var(--muted)}
    .input{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--ink);color:var(--text)}
    .input[readonly]{opacity:.9}
    .btn{padding:9px 13px;border:1px solid var(--accent);background:var(--ink);border-radius:12px;color:#d1fae5;cursor:pointer;transition:transform .06s ease, box-shadow .12s ease, background .12s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .btn.primary{background:#16a34a;border-color:#16a34a;color:var(--accent-ink)}
    .btn-plain{background:#fff;color:#111;border:1px solid #1f2937;border-radius:12px;padding:9px 13px;font-weight:600}
    .btn-connected{background:#16a34a !important;border-color:#16a34a !important;color:var(--accent-ink)!important}
    .btn-switched{background:#16a34a !important;border-color:#16a34a !important;color:var(--accent-ink)!important}
    .btn-copied{background:#16a34a !important;border-color:#16a34a !important;color:var(--accent-ink)!important}
    .small{font-size:12px;color:var(--muted)}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:5px 12px;font-size:12px;color:#cbd5e1}
    .state-chip{padding:4px 10px;border-radius:999px;border:1px solid var(--border)}
    .state-ok{background:#052e16;color:#86efac;border-color:#16a34a}
    .qr{border:1px dashed var(--border);border-radius:10px;padding:10px;background:var(--ink);display:inline-flex;align-items:center;justify-content:center;min-width:136px;min-height:136px}
    .addr{background:var(--ink);color:#e2e8f0;border:1px solid var(--border);border-radius:10px;padding:8px 10px;min-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .voteGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .voteCard{display:flex;flex-direction:column;height:100%}
    .voteTitle{font-size:14px;font-weight:600;color:#e2e8f0;letter-spacing:.2px;margin-bottom:4px}
    .net-pill{border:1px solid var(--border);border-radius:9999px;padding:6px 10px;font-size:12px;background:#132036}
    .net-pill.ok{background:#052e16;color:#86efac;border-color:#16a34a}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand"><span class="logo">üßÉ</span><h1>The Juice ‚Äî Crypto Escrow Bets</h1></div>
      <div class="row">
        <!-- LOCKED contract address (tooltip shows full) -->
        <input id="contractAddress" class="addr" value="0xb28A7FFd11E62a311d74d33De9be8Ec9cF48107A" readonly title="0xb28A7FFd11E62a311d74d33De9be8Ec9cF48107A"/>
        <button id="connect" class="btn-plain">Connect Wallet</button>
        <button id="switch" class="btn">Switch to Base Sepolia</button>
        <button id="newBet" class="btn">Start New Bet</button>
      </div>
    </div>

    <div class="row" style="gap:10px;margin-bottom:10px">
      <div id="netPill" class="net-pill">Base ‚Ä¢ Sepolia ‚Ä¢ (84532)</div>
      <div class="pill">No bookie. Just code.</div>
    </div>
    <p class="small" style="margin-top:2px">Create a bet, your friend joins and matches the stake, you both confirm the winner, then payout. Refunds are fee-free if deadlines pass.</p>

    <div class="grid grid-3">
      <!-- Create Bet -->
      <div class="card">
        <h3>Create Bet</h3>
        <div class="row">
          <div><label class="label">Stake (ETH)</label><input id="stake" class="input" type="number" step="0.0001" value="0.0014" style="width:140px"/></div>
          <div><label class="label">Stake (USD)</label><input id="stakeUsdInput" class="input" type="number" step="1" value="5" style="width:140px"/></div>
          <div class="row" style="gap:6px;align-items:flex-end">
            <button id="stakeMinus" class="btn" title="Decrease">‚àí</button>
            <button id="stakePlus" class="btn" title="Increase">+</button>
          </div>
        </div>
        <div class="row small" style="margin-top:6px">
          <span style="opacity:.9">Set by USD:</span>
          <button class="btn" id="q1">$1</button>
          <button class="btn" id="q5">$5</button>
          <button class="btn" id="q20">$20</button>
          <span style="margin-left:8px">Custom</span>
          <input id="qCustomUsd" class="input" type="number" min="0" step="1" value="10" style="width:100px"/>
        </div>
        <div id="stakeUsd" class="small">‚âà $0.00</div>

        <div style="height:8px"></div>
        <label class="label">Fee (fixed at 2.5%)</label>
        <input id="feeBps" class="input" value="250" readonly disabled/>

        <div style="height:8px"></div>
        <label class="label">Join deadline (minutes) <span class="small">(5‚Äì43200)</span></label>
        <input id="joinMins" class="input" type="number" min="5" max="43200" value="15"/>

        <div style="height:8px"></div>
        <label class="label">Resolve deadline (minutes) <span class="small">(30‚Äì43200)</span></label>
        <input id="resolveMins" class="input" type="number" min="30" max="43200" value="30"/>

        <div style="height:10px"></div>
        <div class="row"><button id="btnCreate" class="btn primary">Create & Fund</button><button id="btnReset" class="btn">Reset</button></div>
        <div id="createStatus" class="small" style="margin-top:10px"></div>
      </div>

      <!-- Join / Resolve -->
      <div class="card">
        <h3>Join / Resolve</h3>
        <div class="small" id="resolveNote" style="margin-top:4px;opacity:.9">Waiting for both votes‚Ä¶</div>
        <div class="row" style="margin:10px 0">
          <button id="btnJoin" class="btn">Join & Match Stake</button>
          <button id="btnRefund" class="btn">Request Refund</button>
          <button id="btnResolve" class="btn">Payout ‚Äî Finalize Bet!</button>
        </div>
        <div class="voteGrid">
          <div class="card voteCard" style="padding:10px">
            <div class="voteTitle">Creator vote</div>
            <div class="row" style="margin-top:6px">
              <button id="creatorWon" class="btn">Creator won</button>
              <button id="creatorSaysOpponent" class="btn">Opponent won</button>
            </div>
          </div>
          <div class="card voteCard" style="padding:10px">
            <div class="voteTitle">Opponent vote</div>
            <div class="row" style="margin-top:6px">
              <button id="opponentSaysCreator" class="btn">Creator won</button>
              <button id="opponentWon" class="btn">Opponent won</button>
            </div>
          </div>
        </div>
        <div id="actionStatus" class="small" style="margin-top:10px"></div>
      </div>

      <!-- Share / QR -->
      <div class="card">
        <h3>Share / QR</h3>
        <div class="small">Show this to your opponent so they can open the exact bet.</div>
        <div class="row" style="margin-top:8px">
          <input id="betId" class="input" style="width:140px" value="1" readonly/>
          <input id="shareUrl" class="input" readonly/>
          <button id="copyBtn" class="btn">Copy link</button>
        </div>
        <div id="qrBox" class="qr" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- Sticky summary -->
    <div class="row" style="gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:14px;background:rgba(11,19,36,.9);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:14px;padding:12px">
      <div class="chip state-chip" id="sbState">‚Äî</div>
      <div class="chip">Fee: <strong>2.5%</strong></div>
      <div class="chip">Pot: <strong><span id="sbPotEth">0.0000</span> ETH</strong> (<span id="sbPotUsd">$0.00</span>)</div>
      <div class="chip">Winner gets: <strong><span id="sbWinEth">0.0000</span> ETH</strong> (<span id="sbWinUsd">$0.00</span>)</div>
      <a id="lastTx" class="chip" href="#" target="_blank" style="text-decoration:underline">View on Basescan</a>
    </div>
  </div>

<script>
/* ========= Constants & helpers ========= */
const BASE = { idHex:'0x14a34', rpc:'https://sepolia.base.org', explorer:'https://sepolia.basescan.org' };
const FEE_BPS = 250;                 // 2.5% fixed
let   ETH_USD = 3500;                // preview only
const CONTRACT_ADDRESS = '0xb28A7FFd11E62a311d74d33De9be8Ec9cF48107A'; // LOCKED

const $ = (id)=>document.getElementById(id);
function setState(text){
  const el=$('sbState'); el.textContent=text;
  el.classList.add('state-chip');
  if (/Connected/.test(text)) el.classList.add('state-ok'); else el.classList.remove('state-ok');
}
function toast(msg){ $('actionStatus').textContent = msg; }
function updatePreview(){
  const stakeEth = parseFloat($('stake').value||'0')||0;
  const pot = stakeEth*2;
  const win = pot*(1 - FEE_BPS/10000);
  $('sbPotEth').textContent = pot.toFixed(4);
  $('sbPotUsd').textContent = `$${(pot*ETH_USD).toFixed(2)}`;
  $('sbWinEth').textContent = win.toFixed(4);
  $('sbWinUsd').textContent = `$${(win*ETH_USD).toFixed(2)}`;
}
function syncUsdFromEth(){ const v=parseFloat($('stake').value||'0'); $('stakeUsdInput').value=(v*ETH_USD).toFixed(0); updatePreview(); }
function syncEthFromUsd(){ const v=parseFloat($('stakeUsdInput').value||'0'); $('stake').value=(v/ETH_USD).toFixed(4); updatePreview(); }

/* ========= QR & link handling ========= */
(function initQR(){
  const betIdEl = $('betId'), shareEl = $('shareUrl'), qrBox = $('qrBox');
  function makeUrl(){
    try{const u=new URL(location.href);
      if(betIdEl.value) u.searchParams.set('bet', String(betIdEl.value).trim());
      return u.toString();
    }catch(_){return location.href;}
  }
  // seed from ?bet=
  (function(){ const p=new URLSearchParams(location.search); const id=p.get('bet'); if(id){ betIdEl.value=id; }})();
  shareEl.value = makeUrl();
  // initial QR
  qrBox.innerHTML='';
  new QRCode(qrBox,{text:shareEl.value,width:140,height:140,colorDark:'#ffffff',colorLight:'#0b1324',correctLevel:QRCode.CorrectLevel.M});

  $('copyBtn').onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(shareEl.value);
      const btn = $('copyBtn');
      const prev = btn.textContent; btn.textContent='Copied!'; btn.classList.add('btn-copied');
      setTimeout(()=>{ btn.textContent=prev; btn.classList.remove('btn-copied'); }, 1200);
    }catch(_){}
  };

  // utility after create to refresh link & QR
  window._updateShareForBet = function(betId){
    betIdEl.value = String(betId);
    shareEl.value = makeUrl();
    qrBox.innerHTML='';
    new QRCode(qrBox,{text:shareEl.value,width:140,height:140,colorDark:'#ffffff',colorLight:'#0b1324',correctLevel:QRCode.CorrectLevel.M});
  }
})();

/* ========= Wallet / network ========= */
let provider, signer; let activeNet = 'unknown';

async function detectNetworkUI(){
  if (!window.ethereum){ $('netPill').classList.remove('ok'); $('netPill').textContent='No wallet detected'; return; }
  const id = await window.ethereum.request({ method:'eth_chainId' });
  const np = $('netPill');
  if (id === BASE.idHex){ np.textContent='Base ‚Ä¢ Sepolia ‚Ä¢ (84532)'; np.classList.add('ok'); activeNet='BASE_SEP'; }
  else { np.textContent='Wrong network ‚Äî click ‚ÄúSwitch to Base Sepolia‚Äù'; np.classList.remove('ok'); activeNet='other'; }
}

async function ensureBase(){
  if (!window.ethereum){ alert('MetaMask not found'); throw new Error('no wallet'); }
  const current = await window.ethereum.request({ method:'eth_chainId' });
  if (current !== BASE.idHex){
    try{
      await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BASE.idHex }] });
    }catch(e){
      if (e.code===4902){
        await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{ chainId: BASE.idHex, chainName:'Base Sepolia', nativeCurrency:{name:'ETH',symbol:'ETH',decimals:18}, rpcUrls:[BASE.rpc], blockExplorerUrls:[BASE.explorer] }] });
      } else { throw e; }
    }
  }
  await detectNetworkUI();
  $('switch').classList.add('btn-switched');
  $('switch').textContent = 'On Base Sepolia ‚úì';
  toast('‚úÖ Switched to Base Sepolia');
}

async function connect(){
  try{
    await ensureBase();
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = await provider.getSigner();
    setState('Connected');
    $('connect').classList.add('btn-connected');
    await refreshBetStatus();
  }catch(e){
    setState('‚Äî');
  }
}

// react to network/account changes
if (window.ethereum){
  window.ethereum.on?.('chainChanged', async ()=>{ await detectNetworkUI(); });
  window.ethereum.on?.('accountsChanged', async ()=>{
    signer = null;
    setState('‚Äî');
    $('connect').classList.remove('btn-connected');
    await detectNetworkUI();
    toast('üîÑ Account changed ‚Äî please reconnect.');
  });
}

/* ========= Contract ========= */
async function getContract(){
  if (!signer) await connect();
  const ABI = [
    {type:'function',stateMutability:'payable',name:'createBet',inputs:[{name:'stakeWei',type:'uint256'},{name:'feeBps',type:'uint16'},{name:'joinWindowSeconds',type:'uint64'},{name:'resolveWindowSeconds',type:'uint64'}],outputs:[{name:'betId',type:'uint256'}]},
    {type:'function',stateMutability:'payable',name:'joinBet',inputs:[{name:'betId',type:'uint256'}],outputs:[]},
    {type:'function',stateMutability:'nonpayable',name:'confirmWinner',inputs:[{name:'betId',type:'uint256'},{name:'creatorWon',type:'bool'}],outputs:[]},
    {type:'function',stateMutability:'nonpayable',name:'refund',inputs:[{name:'betId',type:'uint256'}],outputs:[]},
    {type:'function',stateMutability:'nonpayable',name:'resolve',inputs:[{name:'betId',type:'uint256'}],outputs:[]}, // if present in your contract
    {type:'function',stateMutability:'view',name:'getBet',inputs:[{name:'betId',type:'uint256'}],outputs:[{type:'address'},{type:'address'},{type:'uint256'},{type:'uint16'},{type:'uint64'},{type:'uint64'},{type:'uint64'},{type:'uint8'},{type:'int8'},{type:'int8'}]}
  ];
  return new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
}

/* ========= Actions ========= */
async function onCreate(){
  $('createStatus').textContent='Sending‚Ä¶';
  try{
    const c = await getContract();
    // clamp + convert minutes to seconds
    const jm = Math.max(5,  Math.min(43200, parseInt($('joinMins').value||'15',10)));
    const rm = Math.max(30, Math.min(43200, parseInt($('resolveMins').value||'30',10)));
    $('joinMins').value = jm; $('resolveMins').value = rm;

    const stakeWei = ethers.parseEther(String($('stake').value||'0'));
    const tx = await c.createBet(stakeWei, FEE_BPS, BigInt(jm*60), BigInt(rm*60), { value: stakeWei });
    $('createStatus').textContent = 'Pending ' + tx.hash;
    const rc = await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;

    // Try to grab betId from logs; if not found, leave the old one
    let betId = '';
    try{
      const ev = rc.logs?.find(l=>l.fragment && (l.fragment.name==='BetCreated' || l.fragment.name==='Created'));
      if (ev && ev.args && ev.args[0]!=null) betId = ev.args[0].toString();
    }catch(_){}
    if (betId) window._updateShareForBet(betId);

    setState('Connected ‚Ä¢ Created');
    $('createStatus').textContent = '‚úÖ Created (check explorer)';
  }catch(e){
    $('createStatus').textContent = '‚ùå ' + (e?.shortMessage||e?.message||e);
  }
}

async function onJoin(){
  $('actionStatus').textContent='Sending‚Ä¶';
  try{
    const c = await getContract();
    const betId = BigInt(String($('betId').value||'0'));
    // read stake from-chain to avoid mismatch
    const b = await c.getBet(betId);
    const stakeWei = b[2];
    const tx = await c.joinBet(betId, { value: stakeWei });
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Joined bet #' + betId;
  }catch(e){
    $('actionStatus').textContent = '‚ùå ' + (e?.shortMessage||e?.message||e);
  }
}

async function onVote(creatorWon){
  $('actionStatus').textContent='Sending‚Ä¶';
  try{
    const c = await getContract();
    const betId = BigInt(String($('betId').value||'0'));
    const tx = await c.confirmWinner(betId, Boolean(creatorWon));
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Vote submitted';
  }catch(e){
    $('actionStatus').textContent = '‚ùå ' + (e?.shortMessage||e?.message||e);
  }
}

async function onResolve(){
  $('actionStatus').textContent='Sending‚Ä¶';
  try{
    const c = await getContract();
    const betId = BigInt(String($('betId').value||'0'));
    // If your contract exposes resolve(betId) call it; otherwise this will revert and you can remove this button.
    const tx = await c.resolve(betId);
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Payout finalized';
  }catch(e){
    $('actionStatus').textContent = '‚ùå ' + (e?.shortMessage||e?.message||e);
  }
}

async function onRefund(){
  $('actionStatus').textContent='Sending‚Ä¶';
  try{
    const c = await getContract();
    const betId = BigInt(String($('betId').value||'0'));
    const tx = await c.refund(betId);
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Refund sent';
  }catch(e){
    $('actionStatus').textContent = '‚ùå ' + (e?.shortMessage||e?.message||e);
  }
}

function startNewBet(){
  // rotate a new ?bet=<random> to avoid reusing links
  const r = Math.floor(Math.random()*1e9);
  window._updateShareForBet(r);
  toast('üÜï New bet link prepared ‚Äî share the QR!');
}

/* ========= Bet status (lightweight) ========= */
async function refreshBetStatus(){ /* placeholder for future read-only UI */ }

/* ========= Wire UI ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  // USD/ETH preview
  syncEthFromUsd(); // uses the $5 default to set ETH
  $('stake').addEventListener('input', syncUsdFromEth);
  $('stakeUsdInput').addEventListener('input', syncEthFromUsd);
  $('q1').onclick  = ()=>{ $('stakeUsdInput').value=1;  syncEthFromUsd(); };
  $('q5').onclick  = ()=>{ $('stakeUsdInput').value=5;  syncEthFromUsd(); };
  $('q20').onclick = ()=>{ $('stakeUsdInput').value=20; syncEthFromUsd(); };
  $('stakePlus').onclick = ()=>{ const v=parseFloat($('stake').value||'0')+0.0001; $('stake').value=v.toFixed(4); syncUsdFromEth(); };
  $('stakeMinus').onclick= ()=>{ const v=Math.max(0, parseFloat($('stake').value||'0')-0.0001); $('stake').value=v.toFixed(4); syncUsdFromEth(); };

  // wallet / network / actions
  $('connect').onclick = connect;
  $('switch').onclick  = ensureBase;
  $('newBet').onclick  = startNewBet;

  $('btnCreate').onclick = onCreate;
  $('btnReset').onclick  = ()=>{ $('stakeUsdInput').value='5'; syncEthFromUsd(); $('joinMins').value='15'; $('resolveMins').value='30'; };
  $('btnJoin').onclick   = onJoin;
  $('btnRefund').onclick = onRefund;
  $('btnResolve').onclick= onResolve;

  detectNetworkUI();
});
</script>
</body>
</html>
