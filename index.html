<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The Juice â€” Crypto Escrow Bets</title>

<style>
  :root{
    --bg:#0b1220; --card:#111a2b; --text:#e7eaf0; --muted:#9aa6b2; --border:#22314d;
    --accent:#22c55e; --accent-ink:#052e16; --chip:#0d1627; --radius:16px; --space:14px; --fs:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1a);color:var(--text);font:600 var(--fs)/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .container{max-width:1280px;margin:22px auto;padding:0 20px}
  .header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px}
  .title{font-size:28px;font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#062216;border:1px solid var(--accent);color:#a7f3d0;padding:6px 12px;border-radius:999px;font-size:12.5px}
  .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 12px;font-size:12.5px;color:#cbd5e1}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-left:auto}
  .addr{background:#0d1627;border:1px solid var(--border);border-radius:10px;padding:10px 12px;min-width:300px;max-width:560px;font-family:ui-monospace,Menlo,Consolas,monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#e2e8f0}
  .btn{min-height:42px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#0f172a;color:#dfe7ef;cursor:pointer;transition:transform .06s ease,box-shadow .12s ease,background .12s ease;font-weight:600}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:var(--accent-ink);font-weight:800;box-shadow:0 0 0 0 rgba(34,197,94,.45)}
  .btn.small{padding:7px 10px;font-size:13px;border-radius:10px}
  .btn.connected{background:var(--accent);color:var(--accent-ink);border-color:var(--accent)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .grid{display:grid;gap:16px}
  @media(min-width:1024px){.grid-3{grid-template-columns:1.25fr 1fr 1.05fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.25);display:flex;flex-direction:column;height:100%}
  h3{margin:0 0 10px 0;font-size:20px}
  .label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .input{width:100%;height:44px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0b1324;color:var(--text);font-size:15px}
  .help{font-size:12px;color:var(--muted)}
  .state{background:#0b1324;border:1px solid var(--border);border-radius:12px;padding:6px 10px;color:#cbd5e1}
  .state.ok{background:var(--accent-ink);border-color:var(--accent);color:#a7f3d0}
  .voteWrap{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
  .voteBox{border:1px solid var(--border);border-radius:12px;background:#0b1324;padding:12px}
  .voteTitle{margin:6px 0 2px;font-weight:700}
  #qrBox{border:1px dashed var(--border);border-radius:12px;padding:14px;background:#0b1324;display:flex;align-items:center;justify-content:center;min-width:156px;min-height:156px}
  .sticky{position:sticky;bottom:0;background:rgba(11,19,36,.9);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:14px;padding:10px;margin-top:14px}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .btn-created{background:#16a34a!important;border-color:#16a34a!important;color:#052e16!important;box-shadow:0 0 0 6px rgba(22,163,74,.18)!important}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">ðŸ§ƒ <span>The Juice â€” Crypto Escrow Bets</span></div>
      <div class="toolbar">
        <div class="addr" id="addrPill" title="Escrow contract address (locked)"></div>
        <button id="btnConnect" class="btn">Connect Wallet</button>
        <button id="btnSwitch" class="btn">Switch to Base Sepolia</button>
        <button id="btnNewBet" class="btn small">Start New Bet</button>
      </div>
      <div class="row">
        <span class="pill">Base â€¢ Sepolia â€¢ (84532)</span>
        <span class="chip">No bookie. Just code.</span>
      </div>
    </div>

    <p class="help">Create a bet, your friend joins and matches the stake, you both confirm the winner, then payout. Refunds are fee-free if deadlines pass.</p>

    <div class="grid grid-3">
      <!-- Create -->
      <div class="card">
        <h3>Create Bet</h3>
        <div class="row">
          <div style="min-width:220px;flex:1">
            <label class="label">Stake (ETH)</label>
            <input id="stakeEth" class="input" type="number" step="0.0001" value="0.0014"/>
          </div>
          <div style="min-width:220px;flex:1">
            <label class="label">Stake (USD)</label>
            <input id="stakeUsd" class="input" type="number" step="1" value="5"/>
          </div>
          <div class="row" style="align-self:flex-end">
            <button id="ethMinus" class="btn small">âˆ’</button>
            <button id="ethPlus"  class="btn small">+</button>
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <span class="label" style="margin:0">Set by USD:</span>
          <button class="btn small" id="usd1">$1</button>
          <button class="btn small" id="usd5">$5</button>
          <button class="btn small" id="usd20">$20</button>
          <span class="label" style="margin:0 0 0 8px">Custom</span>
          <input id="usdCustom" class="input" type="number" min="0" step="1" value="10" style="width:120px"/>
        </div>
        <div class="help" id="usdPreview" style="margin-top:4px">â‰ˆ $0.00</div>

        <label class="label" style="margin-top:10px">Fee (fixed at 2.5%)</label>
        <input id="feeBps" class="input" value="250" readonly disabled/>

        <label class="label" style="margin-top:10px">Join deadline (minutes) <span class="help">(5â€“43200)</span></label>
        <input id="joinMins" class="input" type="number" min="5" max="43200" value="15"/>

        <label class="label" style="margin-top:10px">Resolve deadline (minutes) <span class="help">(30â€“43200)</span></label>
        <input id="resolveMins" class="input" type="number" min="30" max="43200" value="30"/>

        <div class="row" style="margin-top:10px">
          <button id="btnCreate" class="btn primary">Create & Fund</button>
          <button id="btnReset" class="btn">Reset</button>
        </div>
        <div id="createStatus" class="help" style="margin-top:8px"></div>
      </div>

      <!-- Join / Resolve -->
      <div class="card">
        <h3>Join / Resolve</h3>
        <div class="help" id="resolveNote" style="margin:6px 0 12px">Waiting for both votesâ€¦</div>

        <div class="row" style="margin-bottom:10px">
          <button id="btnJoin" class="btn">Join & Match Stake</button>
          <button id="btnRefund" class="btn">Request Refund</button>
        </div>

        <button id="btnPayout" class="btn" style="width:100%;margin-bottom:10px">Payout â€” Finalize Bet!</button>

        <div class="voteWrap">
          <div class="voteBox">
            <p class="voteTitle">Creator vote</p>
            <div class="row">
              <button id="creatorWon" class="btn">Creator won</button>
              <button id="creatorSaysOpponent" class="btn">Opponent won</button>
            </div>
          </div>
          <div class="voteBox">
            <p class="voteTitle">Opponent vote</p>
            <div class="row">
              <button id="opponentSaysCreator" class="btn">Creator won</button>
              <button id="opponentWon" class="btn">Opponent won</button>
            </div>
          </div>
        </div>

        <div id="actionStatus" class="help" style="margin-top:10px"></div>
        <div id="newBetNote" class="help" style="display:none;margin-top:10px">ðŸ†• New bet link prepared â€” share the QR!</div>
      </div>

      <!-- Share / QR + Bet Ideas -->
      <div class="card">
        <h3>Share / QR</h3>
        <div class="help">Show this to your opponent so they can open the exact bet.</div>
        <div class="row" style="margin-top:8px">
          <input id="betId" class="input" style="width:140px" value="1"/>
          <input id="shareUrl" class="input" readonly/>
          <button id="btnCopy" class="btn small">Copy link</button>
        </div>
        <div id="qrBox" style="margin-top:10px"></div>

        <h3 style="margin-top:16px">Bet Ideas</h3>
        <div class="help">Tap shuffle to get a quick, fair challenge idea you can use IRL.</div>
        <div class="row" style="margin-top:8px">
          <input id="ideaBox" class="input" readonly value="Make a 3-point shot from the top of the key"/>
          <button id="btnShuffle" class="btn small">Shuffle</button>
        </div>
      </div>
    </div>

    <div class="sticky">
      <div class="kpi">
        <div class="state" id="sbState">â€”</div>
        <div class="chip">Fee: <strong>2.5%</strong></div>
        <div class="chip">Pot: <strong><span id="sbPotEth">0.0000</span> ETH</strong> (<span id="sbPotUsd">$0.00</span>)</div>
        <div class="chip">Winner gets: <strong><span id="sbWinEth">0.0000</span> ETH</strong> (<span id="sbWinUsd">$0.00</span>)</div>
        <a id="lastTx" class="chip" href="#" target="_blank" style="text-decoration:underline">View on Basescan</a>
      </div>
    </div>
  </div>

<script>
/* ---------- Config ---------- */
const BASE = { idHex:'0x14a34', rpc:'https://sepolia.base.org', explorer:'https://sepolia.basescan.org' };
const FEE_BPS = 250;
let   ETH_USD = 3500;
const CONTRACT_ADDRESS = '0xD251F4aFB44Fa54Af8E714C8219d5a535Bc59433'; // your current verified addr

/* ---------- Tiny helpers ---------- */
const $ = (id)=>document.getElementById(id);
const fmtUsd = v => '$' + v.toFixed(2);
function setBusy(el, busy=true){ try{ el.toggleAttribute('disabled', busy);}catch{} }

/* ---------- Header contract pill ---------- */
$('addrPill').textContent = `Contract: ${CONTRACT_ADDRESS}`;

/* ---------- QR helpers ---------- */
function currentShareUrl(){
  const betId = $('betId').value || '1';
  try{ const u=new URL(location.href); u.searchParams.set('bet', betId); return u.toString(); }
  catch{ return location.href; }
}
function renderQR(){
  const node=$('qrBox'); node.innerHTML='';
  new QRCode(node,{text:currentShareUrl(),width:160,height:160,colorDark:'#ffffff',colorLight:'#0b1324',correctLevel:QRCode.CorrectLevel.M});
}

/* ---------- USD/ETH preview ---------- */
function updatePreview(){
  const eth = parseFloat($('stakeEth').value||'0') || 0;
  const pot = eth*2;
  const win = pot*(1 - FEE_BPS/10000);
  $('sbPotEth').textContent = pot.toFixed(4);
  $('sbPotUsd').textContent = fmtUsd(pot*ETH_USD);
  $('sbWinEth').textContent = win.toFixed(4);
  $('sbWinUsd').textContent = fmtUsd(win*ETH_USD);
  $('usdPreview').textContent = 'â‰ˆ ' + fmtUsd(eth*ETH_USD);
}
function syncUsdFromEth(){ $('stakeUsd').value = (parseFloat($('stakeEth').value||'0')*ETH_USD).toFixed(0); updatePreview(); }
function syncEthFromUsd(){ $('stakeEth').value = (parseFloat($('stakeUsd').value||'0')/ETH_USD).toFixed(4); updatePreview(); }

/* ---------- Wallet / ethers ---------- */
let provider, signer;
const ABI = [
  {type:'function',stateMutability:'payable',   name:'createBet',   inputs:[{name:'stakeWei',type:'uint256'},{name:'feeBps',type:'uint16'},{name:'joinWindowSeconds',type:'uint64'},{name:'resolveWindowSeconds',type:'uint64'}], outputs:[{name:'betId',type:'uint256'}]},
  {type:'function',stateMutability:'payable',   name:'joinBet',     inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'confirmWinner',inputs:[{name:'betId',type:'uint256'},{name:'creatorWon',type:'bool'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'refund',      inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'resolve',     inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'view',      name:'getBet',      inputs:[{name:'betId',type:'uint256'}], outputs:[{type:'address'},{type:'address'},{type:'uint256'},{type:'uint16'},{type:'uint64'},{type:'uint64'},{type:'uint64'},{type:'uint8'},{type:'int8'},{type:'int8'}]}
];
async function ensureBase(){
  if(!window.ethereum){ alert('MetaMask not found'); throw new Error('no wallet'); }
  const chain = await window.ethereum.request({ method:'eth_chainId' });
  if(chain !== BASE.idHex){
    try{ await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BASE.idHex }] }); }
    catch(e){
      if(e.code===4902){
        await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{ chainId: BASE.idHex, chainName:'Base Sepolia', nativeCurrency:{name:'ETH',symbol:'ETH',decimals:18}, rpcUrls:[BASE.rpc], blockExplorerUrls:[BASE.explorer]}] });
      } else { throw e; }
    }
  }
}
async function connect(){
  try{
    await ensureBase();
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts',[]);
    signer = await provider.getSigner();
    $('sbState').textContent='Connected'; $('sbState').classList.add('ok');
    $('btnConnect').classList.add('connected');
  }catch(e){
    $('sbState').textContent='â€”'; $('sbState').classList.remove('ok');
  }
}
function getContract(){
  if(!signer) throw new Error('Connect your wallet first.');
  return new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
}

/* ---------- Actions ---------- */
async function doCreate(){
  const b = $('btnCreate'); setBusy(b,true);
  $('createStatus').textContent='Sendingâ€¦';
  try{
    if(!signer) await connect();
    const c = getContract();
    const stakeEth = String($('stakeEth').value||'0');
    const jm = Math.max(5,Math.min(43200,parseInt($('joinMins').value||'15',10)));
    const rm = Math.max(30,Math.min(43200,parseInt($('resolveMins').value||'30',10)));
    $('joinMins').value=jm; $('resolveMins').value=rm;
    const stakeWei = ethers.parseEther(stakeEth);
    const tx = await c.createBet(stakeWei, FEE_BPS, BigInt(jm*60), BigInt(rm*60), { value: stakeWei });
    $('createStatus').textContent='Pending '+tx.hash;
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('createStatus').textContent='âœ… Created (check explorer)';
    // highlight success
    b.classList.add('btn-created','connected');
    setTimeout(()=>b.classList.remove('btn-created'), 1500);
    $('newBetNote').style.display='flex';
  }catch(e){
    $('createStatus').textContent='âŒ '+(e?.shortMessage||e?.message||e);
  }finally{ setBusy(b,false); }
}

async function doJoin(){
  const b=$('btnJoin'); setBusy(b,true);
  $('actionStatus').textContent='Sendingâ€¦';
  try{
    if(!signer) await connect();
    const c = getContract();
    const betId = BigInt(String($('betId').value||'0'));
    const bInfo = await c.getBet(betId);
    const stakeWei = bInfo[2];
    const tx = await c.joinBet(betId, { value: stakeWei });
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent='âœ… Joined bet #'+ String(betId);
  }catch(e){
    $('actionStatus').textContent='âŒ '+(e?.shortMessage||e?.message||e);
  }finally{ setBusy(b,false); }
}

async function doVote(creatorWon){
  $('actionStatus').textContent='Sendingâ€¦';
  try{
    if(!signer) await connect();
    const c = getContract();
    const betId = BigInt(String($('betId').value||'0'));
    const tx = await c.confirmWinner(betId, !!creatorWon);
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent='âœ… Vote submitted';
  }catch(e){
    $('actionStatus').textContent='âŒ '+(e?.shortMessage||e?.message||e);
  }
}

async function doRefund(){
  const b=$('btnRefund'); setBusy(b,true);
  $('actionStatus').textContent='Sendingâ€¦';
  try{
    if(!signer) await connect();
    const c = getContract();
    const betId = BigInt(String($('betId').value||'0'));
    const tx = await c.refund(betId);
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent='âœ… Refund sent';
  }catch(e){
    $('actionStatus').textContent='âŒ '+(e?.shortMessage||e?.message||e);
  }finally{ setBusy(b,false); }
}

async function doPayout(){
  const b=$('btnPayout'); setBusy(b,true);
  $('actionStatus').textContent='Sendingâ€¦';
  try{
    if(!signer) await connect();
    const c = getContract();
    const betId = BigInt(String($('betId').value||'0'));
    const tx = await c.resolve(betId);
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent='âœ… Payout finalized';
  }catch(e){
    $('actionStatus').textContent='âŒ '+(e?.shortMessage||e?.message||e);
  }finally{ setBusy(b,false); }
}

/* ---------- Bet Ideas ---------- */
const IDEAS = [
  "Make a 3-point shot from the top of the key",
  "Darts: hit any double in 3 throws",
  "Cornhole: 2 in a row",
  "Bottle flip: 3 out of 5",
  "Soccer: crossbar in 3 tries",
  "Pool: bank shot within 2 tries",
  "Mini golf: closest-to-the-pin from 15ft",
  "Ping pong: serve an ace in 5 serves"
];
function shuffleIdea(){ $('ideaBox').value = IDEAS[Math.floor(Math.random()*IDEAS.length)]; }

/* ---------- New bet link ---------- */
function genBetId(){ return String(Math.floor(10_000_000 + Math.random()*90_000_000)); }
function startNewBet(){
  const id = genBetId();
  $('betId').value=id;
  $('shareUrl').value=currentShareUrl();
  renderQR();
  $('newBetNote').style.display='flex';
}

/* ---------- Wire UI ---------- */
window.addEventListener('DOMContentLoaded', ()=>{
  updatePreview();
  // stake â†” USD sync
  $('stakeEth').addEventListener('input', syncUsdFromEth);
  $('stakeUsd').addEventListener('input', syncEthFromUsd);
  $('usd1').onclick=()=>{ $('stakeUsd').value=1;  syncEthFromUsd(); };
  $('usd5').onclick=()=>{ $('stakeUsd').value=5;  syncEthFromUsd(); };
  $('usd20').onclick=()=>{ $('stakeUsd').value=20; syncEthFromUsd(); };
  $('ethPlus').onclick =()=>{ const v=Math.max(0,parseFloat($('stakeEth').value||'0')+0.0001); $('stakeEth').value=v.toFixed(4); syncUsdFromEth(); };
  $('ethMinus').onclick=()=>{ const v=Math.max(0,parseFloat($('stakeEth').value||'0')-0.0001); $('stakeEth').value=v.toFixed(4); syncUsdFromEth(); };
  $('usdCustom').addEventListener('input', ()=>{ $('stakeUsd').value=$('usdCustom').value; syncEthFromUsd(); });

  // share/QR
  renderQR();
  $('betId').addEventListener('input', ()=>{ $('shareUrl').value=currentShareUrl(); renderQR(); });
  $('shareUrl').value=currentShareUrl();
  $('btnCopy').onclick = async()=>{ try{ await navigator.clipboard.writeText($('shareUrl').value); $('btnCopy').classList.add('connected'); setTimeout(()=>$('btnCopy').classList.remove('connected'),800);}catch{} };

  // wallet / chain
  $('btnConnect').onclick = connect;
  $('btnSwitch').onclick  = async()=>{ try{ await ensureBase(); $('btnSwitch').classList.add('connected'); setTimeout(()=>$('btnSwitch').classList.remove('connected'),800);}catch{} };

  // actions
  $('btnCreate').onclick = doCreate;
  $('btnReset').onclick  = ()=>{ $('stakeEth').value='0.0014'; $('stakeUsd').value='5'; $('joinMins').value='15'; $('resolveMins').value='30'; updatePreview(); };
  $('btnJoin').onclick   = doJoin;
  $('btnRefund').onclick = doRefund;
  $('creatorWon').onclick= ()=>doVote(true);
  $('creatorSaysOpponent').onclick= ()=>doVote(false);
  $('opponentSaysCreator').onclick= ()=>doVote(true);
  $('opponentWon').onclick= ()=>doVote(false);
  $('btnPayout').onclick = doPayout;

  // ideas + new bet
  $('btnShuffle').onclick = shuffleIdea;
  $('btnNewBet').onclick  = startNewBet;

  // hydrate from ?bet=
  const p=new URLSearchParams(location.search); const b=p.get('bet'); if(b){ $('betId').value=b; $('shareUrl').value=currentShareUrl(); renderQR(); }
});
</script>
</body>
</html>
