<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>The Juice â€” Crypto Escrow Bets</title>

  <style>
    :root{
      --bg:#050608;
      --card:#16171b;
      --card-soft:#1c1d22;
      --text:#f4f4f5;
      --muted:#a1a1aa;
      --border:#27272f;
      --accent:#22c55e;
      --accent-ink:#052e16;
      --danger:#ef4444;
      --chip:#111114;
      --radius:20px; /* Slightly rounder */
      --fs:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:#000;
      color:var(--text);
      font:500 var(--fs)/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing: antialiased;
    }

    .app{
      max-width:680px; /* Tightened max-width for better focus */
      margin:0 auto;
      padding:30px 20px 60px;
    }

    /* --- Header --- */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
      padding:0 4px;
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      font-size:20px;
      letter-spacing: -0.5px;
    }
    .brand-logo{
      width:32px;
      height:32px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      background:var(--card-soft);
      border:1px solid var(--border);
    }
    .brand-logo img {
      width: 20px;
      height: 20px;
      display: block;
    }

    /* --- Buttons / Chips --- */
    .btn{
      border-radius:999px;
      border:1px solid var(--border);
      background:#101014;
      color:var(--text);
      padding:10px 20px;
      font-size:14px;
      font-weight: 500;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:all .2s ease;
      min-height: 40px;
    }
    .btn:hover{
      transform:translateY(-1px);
      background:#18181b;
      border-color: #3f3f46;
    }
    .btn:active{ transform:translateY(0); }

    .btn.primary{
      background:#f9fafb;
      color:#020617;
      border-color:#f9fafb;
      font-weight:600;
    }
    .btn.primary:hover{
      background:#e2e8f0;
      border-color:#e2e8f0;
    }
    .btn.accent{
      background:var(--accent);
      border-color:var(--accent);
      color:var(--accent-ink);
      font-weight:700;
    }
    .btn.accent:hover{
      background:#16a34a;
      border-color:#16a34a;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
    }
    .btn.ghost{
      background:transparent;
      border-color:var(--border);
      color:var(--muted);
    }
    .btn.ghost:hover{
      color:var(--text);
      border-color:var(--muted);
    }
    .btn.small{
      padding:6px 14px;
      font-size:13px;
      min-height: 32px;
    }
    .btn.connected{
      border-color:var(--accent);
      color:var(--accent);
      background: rgba(34, 197, 94, 0.05);
    }

    /* Chips */
    .chip{
      background:var(--chip);
      border-radius:6px;
      border:1px solid var(--border);
      padding:6px 10px;
      font-size:11px;
      font-weight: 500;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
      transition: all 0.2s;
    }
    .chip.badge{
      border-color:rgba(34, 197, 94, 0.3);
      color:var(--accent);
      background: rgba(34, 197, 94, 0.05);
    }
    .chip a{ color:inherit; text-decoration:none; }
    .chip:active { background: var(--accent); color: var(--accent-ink); }

    /* --- Subbar Info --- */
    .subbar{
      display:flex;
      flex-direction:column;
      align-items: center;
      gap:12px;
      margin-bottom:24px;
    }
    .addr{
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      color: var(--muted);
      padding:8px 16px;
      font-size:12px;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      text-align:center;
      max-width: 100%;
      word-break: break-all;
      transition: color 0.2s;
    }
    .addr:hover{ color: var(--text); border-color: #3f3f46; }

    .subchips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
    }

    /* --- Tabs --- */
    .tabs{
      display:flex;
      background:#000;
      border-radius:999px;
      border:1px solid var(--border);
      padding:4px;
      margin:0 auto 24px;
      max-width:100%;
      position: sticky;
      top: 10px;
      z-index: 10;
      box-shadow: 0 10px 20px -10px rgba(0,0,0,0.5);
    }
    .tab{
      flex:1;
      border-radius:999px;
      border:none;
      background:transparent;
      color:var(--muted);
      padding:10px 0;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      transition:all .2s ease;
    }
    .tab:hover{ color: var(--text); }
    .tab.active{
      background:var(--card-soft);
      color:var(--text);
      font-weight:600;
      border: 1px solid var(--border);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    /* --- Panels & Cards --- */
    .panel{display:none}
    .panel.active{display:block; animation: fadeIn 0.3s ease;}
    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

    .card{
      border-radius:var(--radius);
      background:var(--card);
      border:1px solid var(--border);
      padding:32px 28px; /* More breathing room */
      box-shadow:0 20px 60px rgba(0,0,0,0.6);
      margin:0 auto;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .card-title{
      font-size:20px;
      font-weight:700;
      letter-spacing: -0.02em;
    }
    .card-sub{
      font-size:14px;
      color:var(--muted);
      text-align:center;
      margin-bottom:24px;
      line-height: 1.5;
    }

    /* --- Inputs & Labels --- */
    .label{
      font-size:13px;
      color:var(--muted);
      margin-bottom:8px;
      display:block;
      font-weight: 500;
    }
    .input{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0a0a0c;
      color:var(--text);
      padding:12px 16px;
      font-size:15px;
      transition: border-color 0.2s;
    }
    .input:focus{
      outline:none;
      border-color:var(--accent);
    }
    .input::placeholder{color:#3f3f46}

    .row{ display:flex; align-items:center; gap:12px; }
    .row.wrap{ flex-wrap:wrap; }
    .stack{ display:flex; flex-direction:column; gap:12px; }

    .idea-input{
      flex: 1;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0a0a0c;
      color:var(--text);
      padding:12px 16px;
      font-size:15px;
    }

    /* --- Stake Area (The Money Shot) --- */
    .stake-area{
      margin:24px 0;
      padding: 24px;
      background: var(--card-soft);
      border-radius: 16px;
      border: 1px solid var(--border);
      text-align:center;
    }
    .stake-label{
      font-size:13px;
      color:var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      margin-bottom:12px;
    }
    .stake-main{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      margin-bottom:16px;
    }
    .stake-symbol{
      font-size:24px;
      color:#52525b;
      font-weight: 300;
      margin-top: 6px; 
    }
    .stake-amount{
      font-size:48px;
      font-weight:700;
      width: 180px; /* Fixed width to prevent jumping */
      text-align:center;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      padding: 0;
      margin: 0;
      line-height: 1;
    }
    .stake-toggle{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .stake-toggle button{
      border-radius:4px;
      border:1px solid var(--border);
      background:transparent;
      padding:2px 6px;
      font-size:10px;
      font-weight: 700;
      color:#52525b;
      cursor:pointer;
      transition: all 0.2s;
    }
    .stake-toggle button:hover { border-color: var(--muted); color: var(--text); }
    .stake-toggle button.connected{
      border-color:var(--accent);
      color:var(--accent);
      background: rgba(34, 197, 94, 0.1);
    }

    /* Stake Controls */
    .stake-controls {
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap: wrap;
    }
    .stake-controls button {
      min-width: 44px;
    }

    /* --- Quick Chips --- */
    .quick-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      flex: 1;
    }
    .quick-chip{
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--card-soft);
      color:var(--muted);
      padding:8px 12px;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      transition: all 0.2s;
    }
    .quick-chip:hover{
      border-color:#52525b;
      color: var(--text);
      background: #27272a;
    }
    .deadline-input{
      width: 90px;
      text-align: center;
    }

    .footer-note{
      font-size:12px;
      color:#52525b;
      margin-top:8px;
      text-align:right;
      font-style: italic;
    }

    .status{
      margin-top:16px;
      font-size:13px;
      color:var(--muted);
      min-height:20px;
      text-align: center;
    }

    /* --- Join / Resolve --- */
    .join-input-row{
      margin-bottom:16px;
      gap: 8px;
    }
    .join-input{ flex:1; }
    .btn-clear{
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card-soft);
      color:var(--muted);
      padding:0 16px;
      font-size:12px;
      cursor:pointer;
      height: 48px; /* Match input height */
    }
    .btn-clear:hover { color: var(--text); border-color: var(--muted); }

    .resolve-section{
      margin-top:24px;
      padding-top:20px;
      border-top:1px dashed var(--border);
    }
    .resolve-title{
      font-size:14px;
      color:var(--text);
      font-weight: 600;
      text-align:center;
      margin-bottom:4px;
    }
    .resolve-sub{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      margin-bottom:16px;
    }
    .vote-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-bottom:16px;
    }
    .vote-col {
      background: #0b0b0e;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid var(--border);
    }
    .vote-column-title{
      font-size:11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color:#52525b;
      text-align:center;
      margin-bottom:10px;
      font-weight: 700;
    }
    .vote-buttons{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .vote-buttons .btn { width: 100%; }

    /* --- Share / QR --- */
    .share-card{
      margin-top:20px;
      border-radius:18px;
      background:var(--card-soft);
      border:1px solid var(--border);
      padding:20px;
    }
    .share-title{
      font-size:15px;
      font-weight:600;
      margin-bottom:6px;
    }
    .share-help{
      font-size:12px;
      color:var(--muted);
      margin-bottom:16px;
    }
    .qr-row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items: flex-start;
    }
    .qr-box{
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      padding: 10px;
      width:150px;
      height:150px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-top:10px;
    }

    /* --- Summary Footer --- */
    .summary-card{
      margin-top:24px;
      border-radius:18px;
      background:#08080b;
      border:1px solid var(--border);
      padding:16px 20px;
      font-size:13px;
      max-width:100%;
    }
    .summary-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:8px;
      flex-wrap:wrap;
      padding-bottom: 12px;
      border-bottom: 1px solid #1c1c20;
    }
    .state-pill{
      border-radius:6px;
      border:1px solid var(--border);
      background:#101014;
      padding:4px 10px;
      font-size:11px;
      font-weight: 600;
      color:var(--muted);
    }
    .state-pill.ok{
      border-color:rgba(34, 197, 94, 0.3);
      color:var(--accent);
      background:rgba(34, 197, 94, 0.1);
    }
    .summary-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .summary-label{color:#71717a;}
    .summary-value{font-weight:500; color: var(--text);}
    .summary-link{
      font-size:12px;
      color:#71717a;
      text-decoration:underline;
      transition: color 0.2s;
    }
    .summary-link:hover { color: var(--accent); }

    .help-line{
      font-size:11px;
      color:#52525b;
      margin-top:12px;
      text-align:center;
    }

    /* Special Buttons */
    #ethMinus, #ethPlus{
      font-size:18px;
      line-height: 1;
      padding: 0 16px;
    }
    #ethMinus:active, #ethPlus:active{
      background:var(--accent);
      color:var(--accent-ink);
      border-color:var(--accent);
    }
    #btnReset{
      border:1px solid rgba(239, 68, 68, 0.3);
      color:var(--danger);
      background:rgba(239, 68, 68, 0.05);
    }
    #btnReset:hover,#btnReset:active{
      background:var(--danger);
      color:#fff;
      border-color:var(--danger);
    }

    /* Mobile Tweaks */
    @media(max-width:600px){
      .app{padding:16px 16px 40px}
      .card{padding:20px 16px}
      .stake-amount{font-size:40px; width: 140px;}
      .quick-row { justify-content: flex-start; }
      .qr-row { flex-direction: column; }
      #qrBox { margin: 10px auto; }
      .vote-grid { gap: 8px; }
      .vote-col { padding: 10px 8px; }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<div class="app">
  <header class="topbar">
    <div class="brand">
      <div class="brand-logo">
        <img src="favicon.png" alt="The Juice logo" />
      </div>
      <span>The Juice</span>
    </div>
    <div class="top-actions">
      <button id="btnSwitch" class="btn small ghost">Switch network</button>
      <button id="btnConnect" class="btn small ghost">Connect Wallet</button>
    </div>
  </header>

  <div class="subbar">
    <div id="addrPill" class="addr" title="Escrow contract address (locked)"></div>
    <div class="subchips">
      <div class="subchips-left" style="display:flex;gap:6px">
        <span id="chipNetwork" class="chip">Base â€¢ Sepolia â€¢ (84532)</span>
        <span class="chip badge">Fee 2.5%</span>
      </div>
      <a class="chip" href="https://sepolia.basescan.org/address/0xD251F4aFB44Fa54Af8E714C8219d5a535Bc59433#code" target="_blank">
        Verified contract â†—
      </a>
    </div>
  </div>

  <div class="tabs">
    <button id="tabCreate" class="tab active">Create Bet</button>
    <button id="tabJoin" class="tab">Join &amp; Resolve</button>
  </div>

  <div id="panelCreate" class="panel active">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Create Bet</div>
      </div>

      <div class="card-sub">Set the bet, deadlines, and fund the escrow in one step.</div>

      <div class="row" style="margin-bottom:20px">
        <input id="ideaBox" class="idea-input" type="text" value="Golf: Hole in one!" />
        <button id="btnShuffle" class="btn small ghost">Shuffle</button>
      </div>

      <div class="stake-area">
        <div class="stake-label">I want to bet</div>
        <div class="stake-main">
          <span class="stake-symbol">$</span>
          <input id="stakeMain" class="stake-amount" type="number" value="5" />
          <div class="stake-toggle">
            <button id="stakeModeEth">ETH</button>
            <button id="stakeModeUsd" class="connected">USD</button>
          </div>
        </div>

        <input id="stakeEth" type="hidden" value="0.0014"/>
        <input id="stakeUsd" type="hidden" value="5"/>

        <div class="stake-controls">
          <button id="usd1" class="btn small ghost">$1</button>
          <button id="usd5" class="btn small ghost">$5</button>
          <button id="usd20" class="btn small ghost">$20</button>
          <button id="ethMinus" class="btn small ghost">âˆ’</button>
          <button id="ethPlus"  class="btn small ghost">+</button>
        </div>
      </div>

      <div style="margin-top:20px">
        <div class="label">Join deadline (minutes)</div>
        <div class="row wrap">
          <div class="quick-row">
            <button class="quick-chip" data-join="15">Quick (15m)</button>
            <button class="quick-chip" data-join="60">1h</button>
            <button class="quick-chip" data-join="1440">1 Day</button>
          </div>
          <input id="joinMins" class="input deadline-input" type="number" min="5" max="43200" value="15"/>
        </div>
      </div>

      <div style="margin-top:20px">
        <div class="label">Resolve deadline (minutes)</div>
        <div class="row wrap">
          <div class="quick-row">
            <button class="quick-chip" data-resolve="30">+30m</button>
            <button class="quick-chip" data-resolve="120">+2h</button>
            <button class="quick-chip" data-resolve="2880">+2 Days</button>
          </div>
          <input id="resolveMins" class="input deadline-input" type="number" min="30" max="43200" value="30"/>
        </div>
      </div>

      <div class="footer-note">USD values are estimates only.</div>

      <div class="row" style="margin-top:24px;gap:12px">
        <button id="btnCreate" class="btn accent" style="flex:1">Create &amp; Fund</button>
        <button id="btnReset" class="btn" style="min-width:90px">Reset</button>
      </div>

      <div id="createStatus" class="status"></div>
    </div>
  </div>

  <div id="panelJoin" class="panel">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Join &amp; Resolve</div>
      </div>
      <div id="resolveNote" class="card-sub">Paste a bet ID to join, refund, or finalize.</div>

      <div class="join-input-row row">
        <input id="betId" class="input join-input" placeholder="Paste bet IDâ€¦" />
        <button id="btnClearId" class="btn-clear">Clear</button>
      </div>

      <div class="stack" style="margin-top:12px">
        <button id="btnJoin" class="btn primary" style="width:100%">Join Bet</button>
        <button id="btnRefund" class="btn ghost" style="width:100%">Request Refund</button>
      </div>

      <div class="resolve-section">
        <div class="resolve-title">Resolve winner</div>
        <div class="resolve-sub">Both sides choose the winner. If they match, payout is automatic.</div>

        <div class="vote-grid">
          <div class="vote-col">
            <div class="vote-column-title">I created this bet</div>
            <div class="vote-buttons">
              <button id="creatorWon" class="btn ghost">I Won</button>
              <button id="creatorSaysOpponent" class="btn ghost">Opponent Won</button>
            </div>
          </div>
          <div class="vote-col">
            <div class="vote-column-title">I joined this bet</div>
            <div class="vote-buttons">
              <button id="opponentSaysCreator" class="btn ghost">Creator Won</button>
              <button id="opponentWon" class="btn ghost">I Won</button>
            </div>
          </div>
        </div>

        <button id="btnPayout" class="btn accent" style="width:100%;margin-top:12px">Finalize &amp; Payout</button>
      </div>

      <div id="actionStatus" class="status"></div>
      <div id="newBetNote" class="status" style="text-align:center;display:none;color:var(--accent)">ðŸ†• New bet link prepared â€” share the QR!</div>
    </div>

    <div class="share-card">
      <div class="share-title">Share link &amp; QR</div>
      <div class="share-help">Send this link or QR to your opponent so they open the exact bet.</div>

      <div class="row wrap">
        <button id="btnCopy" class="btn small ghost">Copy link</button>
        <input id="shareUrl" class="input" style="flex:1" readonly/>
      </div>

      <div class="qr-box" id="qrBox"></div>
    </div>
  </div>

  <div class="summary-card">
    <div class="summary-top">
      <div id="sbState" class="state-pill">Not connected</div>
      <div class="chip">Base Sepolia</div>
    </div>

    <div class="summary-row">
      <span class="summary-label">Pot value</span>
      <span class="summary-value"><span id="sbPotEth">0.0000</span> ETH (<span id="sbPotUsd">$0.00</span>)</span>
    </div>
    <div class="summary-row">
      <span class="summary-label">Winner gets</span>
      <span class="summary-value"><span id="sbWinEth">0.0000</span> ETH (<span id="sbWinUsd">$0.00</span>)</span>
    </div>

    <div class="summary-row" style="margin-top:12px; border-top:1px dashed #27272f; padding-top:8px; width:100%">
      <span class="summary-label">Last transaction</span>
      <a id="lastTx" class="summary-link" href="#" target="_blank" rel="noopener">View on Basescan</a>
    </div>

    <div class="help-line">Refunds are fee-free if deadlines pass.</div>
  </div>
</div>

<script>
/* ---------- Config ---------- */
const BASE = { idHex: '0x14a34', rpc: 'https://sepolia.base.org', explorer: 'https://sepolia.basescan.org' };
const FEE_BPS = 250;        // fixed 2.5%
let   ETH_USD = 3500;       // preview only
const CONTRACT_ADDRESS = '0xD251F4aFB44Fa54Af8E714C8219d5a535Bc59433';

/* ---------- Shortcuts ---------- */
const $  = id => document.getElementById(id);
const fmtUsd = v => '$' + v.toFixed(2);

/* ---------- Fill header contract pill ---------- */
$('addrPill').textContent = `Contract: ${CONTRACT_ADDRESS}`;

/* ---------- QR + share helpers ---------- */
function currentShareUrl() {
  const betId = $('betId').value;
  try{
    const u = new URL(location.href);
    if (betId) {
      u.searchParams.set('bet', betId);
    } else {
      u.searchParams.delete('bet');
    }
    return u.toString();
  }catch{
    return location.href;
  }
}
let qr = null;
function renderQR(){
  const node = $('qrBox');
  if (!node) return;
  node.innerHTML = '';
  qr = new QRCode(node,{
    text: currentShareUrl(),
    width: 140,
    height:140,
    colorDark:'#000000',
    colorLight:'#ffffff',
    correctLevel: QRCode.CorrectLevel.M
  });
}
function setCopyPulse(el){
  el.classList.add('connected');
  setTimeout(()=>el.classList.remove('connected'), 800);
}

/* ---------- USD/ETH preview ---------- */
function updatePreview(){
  const eth = parseFloat($('stakeEth').value || '0') || 0;
  const pot = eth * 2;
  const win = pot * (1 - FEE_BPS/10000);

  const potEthEl = $('sbPotEth');
  if (potEthEl) potEthEl.textContent = pot.toFixed(4);

  const potUsdEl = $('sbPotUsd');
  if (potUsdEl) potUsdEl.textContent = fmtUsd(pot * ETH_USD);

  const winEthEl = $('sbWinEth');
  if (winEthEl) winEthEl.textContent = win.toFixed(4);

  const winUsdEl = $('sbWinUsd');
  if (winUsdEl) winUsdEl.textContent = fmtUsd(win * ETH_USD);
}

/* Hidden fields kept in ETH and USD */
function applyStakeFromEth(rawEth){
  const eth = Math.max(0, Number(rawEth) || 0);
  $('stakeEth').value = eth.toFixed(4);
  $('stakeUsd').value = (eth * ETH_USD).toFixed(0);

  if (stakeMode === 'ETH'){
    $('stakeMain').value = eth.toFixed(4);
  }else{
    $('stakeMain').value = (eth * ETH_USD).toFixed(0);
  }
  updatePreview();
}

/* Single stake box + mode toggle */
let stakeMode = 'USD'; // default: show USD in big box

function handleStakeMainInput(){
  const num = Number($('stakeMain').value) || 0;
  if (stakeMode === 'ETH'){
    applyStakeFromEth(num);
  }else{
    const eth = num / ETH_USD;
    applyStakeFromEth(eth);
  }
}
function setStakeMode(mode){
  if (mode !== 'ETH' && mode !== 'USD') return;
  stakeMode = mode;
  const eth = parseFloat($('stakeEth').value || '0') || 0;

  $('stakeModeEth').classList.toggle('connected', mode === 'ETH');
  $('stakeModeUsd').classList.toggle('connected', mode === 'USD');

  if (mode === 'ETH'){
    $('stakeMain').step = '0.0001';
    $('stakeMain').value = eth.toFixed(4);
  }else{
    $('stakeMain').step = '1';
    $('stakeMain').value = (eth * ETH_USD).toFixed(0);
  }
}

/* ---------- Wallet / ethers ---------- */
let provider, signer;
const ABI = [
  {type:'function',stateMutability:'payable',   name:'createBet',   inputs:[{name:'stakeWei',type:'uint256'},{name:'feeBps',type:'uint16'},{name:'joinWindowSeconds',type:'uint64'},{name:'resolveWindowSeconds',type:'uint64'}], outputs:[{name:'betId',type:'uint256'}]},
  {type:'function',stateMutability:'payable',   name:'joinBet',     inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'confirmWinner',inputs:[{name:'betId',type:'uint256'},{name:'creatorWon',type:'bool'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'refund',      inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'resolve',     inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'view',      name:'getBet',      inputs:[{name:'betId',type:'uint256'}], outputs:[{type:'address'},{type:'address'},{type:'uint256'},{type:'uint16'},{type:'uint64'},{type:'uint64'},{type:'uint64'},{type:'uint8'},{type:'int8'},{type:'int8'}]},
  {type:'function',stateMutability:'view',      name:'nextBetId',   inputs:[], outputs:[{type:'uint256'}]}
];
async function ensureBase(){
  if (!window.ethereum){ alert('MetaMask not found'); throw new Error('no wallet'); }
  const chain = await window.ethereum.request({ method:'eth_chainId' });
  if (chain !== BASE.idHex){
    try{
      await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BASE.idHex }] });
    }catch(e){
      if (e.code === 4902){
        await window.ethereum.request({
          method:'wallet_addEthereumChain',
          params:[{ chainId: BASE.idHex, chainName:'Base Sepolia',
                    nativeCurrency:{name:'ETH',symbol:'ETH',decimals:18},
                    rpcUrls:[BASE.rpc], blockExplorerUrls:[BASE.explorer]}]
        });
      }else{ throw e; }
    }
  }
}
async function connect(){
  try{
    await ensureBase();
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts',[]);
    signer = await provider.getSigner();
    $('sbState').textContent = 'Connected';
    const netChip = $('chipNetwork');
    if (netChip) netChip.classList.add('badge');
    $('sbState').classList.add('ok');
    $('btnConnect').classList.add('connected');
  }catch(e){
    $('sbState').textContent = 'Not connected';
    $('sbState').classList.remove('ok');
  }
}
function getContract(){
  if (!signer) throw new Error('Connect your wallet first.');
  return new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
}
function requireBetId(){
  const raw = String(($('betId').value || '').trim());
  if (!raw) throw new Error('Enter a bet ID first.');
  if (!/^\d+$/.test(raw)) throw new Error('Bet ID must be a number.');
  return BigInt(raw);
}

/* ---------- Actions ---------- */
async function doCreate(){
  $('createStatus').textContent = 'Sendingâ€¦';
  try{
    if (!signer) await connect();
    const c = getContract();
    const stakeEth = String($('stakeEth').value || '0');

    if (Number(stakeEth) <= 0){
      throw new Error('Stake must be greater than zero.');
    }

    const jm = Math.max(5,  Math.min(43200, parseInt($('joinMins').value || '15', 10)));
    const rm = Math.max(30, Math.min(43200, parseInt($('resolveMins').value || '30', 10)));
    $('joinMins').value = jm;
    $('resolveMins').value = rm;

    const stakeWei = ethers.parseEther(stakeEth);
    const tx = await c.createBet(
      stakeWei,
      FEE_BPS,
      BigInt(jm * 60),
      BigInt(rm * 60),
      { value: stakeWei }
    );
    $('createStatus').textContent = 'Pending ' + tx.hash;

    const rc = await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('createStatus').textContent = 'âœ… Bet created';

    const nextId = await c.nextBetId();
    const betId = (BigInt(nextId) - 1n).toString();
    $('betId').value = betId;
    $('shareUrl').value = currentShareUrl();
    renderQR();
    $('newBetNote').style.display = 'block';
  }catch(e){
    console.error('createBet error',e);
    $('createStatus').textContent = 'âŒ ' + (e?.shortMessage||e?.message||e);
  }
}

async function doJoin(){
  $('actionStatus').textContent = 'Sendingâ€¦';
  try{
    if (!signer) await connect();
    const c = getContract();
    const betId = requireBetId();
    const b = await c.getBet(betId);

    if (b[0] === ethers.ZeroAddress){
      $('actionStatus').textContent = 'âŒ Bet not found';
      return;
    }
    if (b[1] !== ethers.ZeroAddress){
      $('actionStatus').textContent = 'âŒ Bet already has an opponent';
      return;
    }

    const stakeWei = b[2];
    const tx = await c.joinBet(betId,{ value: stakeWei });
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = 'âœ… Joined bet #' + betId;
  }catch(e){
    $('actionStatus').textContent = 'âŒ ' + (e?.shortMessage||e?.message||e);
  }
}

async function doVote(creatorWon){
  $('actionStatus').textContent = 'Sendingâ€¦';
  try{
    if (!signer) await connect();
    const c = getContract();
    const betId = requireBetId();
    const b = await c.getBet(betId);

    if (b[0] === ethers.ZeroAddress){
      $('actionStatus').textContent = 'âŒ Bet not found';
      return;
    }
    const state = Number(b[7]);
    if (state !== 1){
      $('actionStatus').textContent = 'âŒ Voting not available';
      return;
    }

    const user = await signer.getAddress();
    if (user !== b[0] && user !== b[1]){
      $('actionStatus').textContent = 'âŒ You are not part of this bet';
      return;
    }

    if ((user === b[0] && b[8] !== -1) || (user === b[1] && b[9] !== -1)){
      $('actionStatus').textContent = 'âœ… Vote already submitted';
      return;
    }

    const tx = await c.confirmWinner(betId, Boolean(creatorWon));
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = 'âœ… Vote submitted';
  }catch(e){
    $('actionStatus').textContent = 'âŒ ' + (e?.shortMessage||e?.message||e);
  }
}

async function doRefund(){
  $('actionStatus').textContent = 'Sendingâ€¦';
  try{
    if (!signer) await connect();
    const c = getContract();
    const betId = requireBetId();
    const tx = await c.refund(betId);
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = 'âœ… Refund sent';
  }catch(e){
    $('actionStatus').textContent = 'âŒ ' + (e?.shortMessage||e?.message||e);
  }
}

async function doPayout(){
  $('actionStatus').textContent = 'Sendingâ€¦';
  try{
    if (!signer) await connect();
    const c = getContract();
    const betId = requireBetId();
    const tx = await c.resolve(betId);
    await tx.wait();
    $('lastTx').href = `${BASE.explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = 'âœ… Payout finalized';
  }catch(e){
    $('actionStatus').textContent = 'âŒ ' + (e?.shortMessage||e?.message||e);
  }
}

/* ---------- Bet Ideas ---------- */
const IDEAS = [
  "Make a 3-point shot from the top of the key",
  "Darts: Hit any double in 3 throws",
  "Darts: You vs Me",
  "Darts: Bullzeye",
  "Drink: Chug under 1 minute",
  "Hockey: Hit the crossbar",
  "Lacrosse: Top right corner",
  "Human: No way!",
  "Human: I bet you can't",
  "Cornhole: 2 in a row",
  "Bottle Flip: 3 out of 5",
  "Soccer: Crossbar in 3 tries",
  "Golf: Hole in one!",
  "Golf: 3-putt?",
  "Golf: 2-putt or better",
  "Golf: Green-in-regulation?",
  "Golf: Fairway off the tee",
  "Gaming: 1 v 1",
  "Speed: I'll beat you there",
  "Pool: You vs Me",
  "Pool: Bank shot within 2 tries",
  "Golf: Closest-to-the-pin",
  "Golf: On the green?",
  "Golf: Low score",
  "Golf: Match Play",
  "Ping pong: Serve an ace in 5 serves"
];
function shuffleIdea(){
  $('ideaBox').value = IDEAS[Math.floor(Math.random()*IDEAS.length)];
}

/* ---------- New bet link ---------- */
function startNewBet(){
  $('betId').value = '';
  $('shareUrl').value = '';
  $('qrBox').innerHTML = '';
  $('newBetNote').style.display = 'none';
}

/* ---------- Wire UI ---------- */
window.addEventListener('DOMContentLoaded', ()=>{
  // stake defaults (start from ETH value, show USD)
  applyStakeFromEth(0.0014);
  setStakeMode('USD');
  $('stakeMain').addEventListener('input', handleStakeMainInput);

  // Mode toggle
  $('stakeModeEth').onclick = ()=> setStakeMode('ETH');
  $('stakeModeUsd').onclick = ()=> setStakeMode('USD');

  // Quick USD buttons
  $('usd1').onclick  = ()=>{ setStakeMode('USD'); $('stakeMain').value = 1;  handleStakeMainInput(); };
  $('usd5').onclick  = ()=>{ setStakeMode('USD'); $('stakeMain').value = 5;  handleStakeMainInput(); };
  $('usd20').onclick = ()=>{ setStakeMode('USD'); $('stakeMain').value = 20; handleStakeMainInput(); };

  // +/- in ETH space
  $('ethPlus').onclick = ()=>{
    const v = Math.max(0, parseFloat($('stakeEth').value || '0') + 0.0001);
    applyStakeFromEth(v);
  };
  $('ethMinus').onclick = ()=>{
    const v = Math.max(0, parseFloat($('stakeEth').value || '0') - 0.0001);
    applyStakeFromEth(v);
  };

  // Quick deadline chips
  document.querySelectorAll('[data-join]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $('joinMins').value = btn.getAttribute('data-join');
    });
  });
  document.querySelectorAll('[data-resolve]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $('resolveMins').value = btn.getAttribute('data-resolve');
    });
  });

  // QR + share
  renderQR();
  $('betId').addEventListener('input', ()=>{
    $('shareUrl').value = currentShareUrl();
    renderQR();
  });
  $('shareUrl').value = currentShareUrl();
  $('btnCopy').onclick = async ()=>{
    try{
      await navigator.clipboard.writeText($('shareUrl').value);
      setCopyPulse($('btnCopy'));
    }catch{}
  };

  // Connect / switch / new bet
  $('btnConnect').onclick = connect;
  $('btnSwitch').onclick = async ()=>{
    try{
      await ensureBase();
      $('btnSwitch').classList.add('connected');
    }catch{}
  };

  const newBetBtn = $('btnNewBet');
  if (newBetBtn) {
    newBetBtn.onclick = () => {
      startNewBet();
      newBetBtn.classList.add('connected');
    };
  }
  
  // Actions
  $('btnCreate').onclick = doCreate;
  $('btnReset').onclick  = ()=>{
    $('joinMins').value = '15';
    $('resolveMins').value = '30';
    applyStakeFromEth(0.0014);
    startNewBet();
  };
  $('btnJoin').onclick    = doJoin;
  $('btnRefund').onclick  = doRefund;
  $('creatorWon').onclick = ()=>doVote(true);
  $('creatorSaysOpponent').onclick = ()=>doVote(false);
  $('opponentSaysCreator').onclick = ()=>doVote(true);
  $('opponentWon').onclick = ()=>doVote(false);
  $('btnPayout').onclick  = doPayout;

  // Shuffle ideas
  $('btnShuffle').onclick = shuffleIdea;

  // Clear bet ID button
  $('btnClearId').onclick = ()=>{
    startNewBet();
    $('betId').value = '';
  };

  // Tabs
  const tabCreate = $('tabCreate');
  const tabJoin   = $('tabJoin');
  const panelCreate = $('panelCreate');
  const panelJoin   = $('panelJoin');
  tabCreate.onclick = ()=>{
    tabCreate.classList.add('active');
    tabJoin.classList.remove('active');
    panelCreate.classList.add('active');
    panelJoin.classList.remove('active');
  };
  tabJoin.onclick = ()=>{
    tabJoin.classList.add('active');
    tabCreate.classList.remove('active');
    panelJoin.classList.add('active');
    panelCreate.classList.remove('active');
  };

  // Read ?bet= on load
  const p = new URLSearchParams(location.search);
  const b = p.get('bet');
  if (b){
    $('betId').value = b;
    $('shareUrl').value = currentShareUrl();
    renderQR();
  }

  // Initial preview
  updatePreview();
});
</script>
</body>
</html>
