<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>The Juice</title>

<style>
  :root {
    --bg: #000000;
    --card: #1c1c1e;
    --card-highlight: #2c2c2e;
    --input-bg: #2c2c2e;
    --text: #ffffff;
    --text-muted: #8e8e93;
    --accent: #30d158; /* iOS Green */
    --accent-dim: rgba(48, 209, 88, 0.15);
    --danger: #ff453a; /* iOS Red */
    --radius: 20px;
    --control-h: 50px; /* Unified height for all controls */
    --ease: cubic-bezier(0.25, 1, 0.5, 1);
  }

  * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
  
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
    display: flex;
    justify-content: center;
    min-height: 100vh;
    padding: 20px 16px;
  }

  /* --- Container --- */
  .app {
    width: 100%;
    max-width: 420px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  /* --- Header --- */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 4px;
  }
  .brand { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
  
  .btn-connect {
    background: var(--card-highlight);
    color: var(--accent);
    border: none;
    height: 36px;
    padding: 0 16px;
    border-radius: 18px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s var(--ease);
  }
  .btn-connect.connected { background: var(--accent-dim); box-shadow: 0 0 0 1px var(--accent) inset; }

  /* --- Tabs --- */
  .nav-tabs {
    background: var(--card);
    padding: 4px;
    border-radius: 16px;
    display: flex;
    position: relative;
  }
  .nav-btn {
    flex: 1;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-weight: 600;
    font-size: 14px;
    height: 36px;
    border-radius: 12px;
    cursor: pointer;
    transition: color 0.2s;
    z-index: 2;
  }
  .nav-btn.active { color: var(--text); background: var(--card-highlight); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

  /* --- Cards --- */
  .view-panel { display: none; animation: slideUp 0.4s var(--ease); }
  .view-panel.active { display: block; }
  
  @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
  }

  /* --- Typography --- */
  h2 { margin: 0 0 16px 0; font-size: 17px; font-weight: 600; text-align: center; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; display: block; padding-left: 4px; }
  .val-highlight { color: var(--text); font-weight: 600; }

  /* --- The Hero Input (Stake) --- */
  .hero-input-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0;
  }
  .hero-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }
  .currency-symbol { font-size: 32px; color: var(--text-muted); font-weight: 400; }
  .hero-input {
    background: transparent;
    border: none;
    color: var(--text);
    font-size: 48px;
    font-weight: 700;
    width: 220px;
    text-align: center;
    outline: none;
    padding: 0;
    margin: 0;
    font-family: inherit;
  }
  /* Remove number spinners */
  .hero-input::-webkit-outer-spin-button, .hero-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .hero-input { -moz-appearance: textfield; }

  .currency-toggle-row {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }
  .pill-xs {
    font-size: 11px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 20px;
    background: var(--card-highlight);
    color: var(--text-muted);
    border: none;
    cursor: pointer;
  }
  .pill-xs.active { background: var(--text); color: var(--bg); }

  /* --- Control Grid (The "Apple" Buttons) --- */
  .control-grid { display: flex; gap: 10px; margin-bottom: 24px; }
  .control-item {
    flex: 1;
    height: var(--control-h);
    background: var(--card-highlight);
    border: none;
    border-radius: 12px;
    color: var(--text);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.1s;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 0;
  }
  .control-item:active { transform: scale(0.98); opacity: 0.8; }
  
  /* Input pretending to be a button */
  input.control-item {
    outline: none;
    color: var(--accent);
    font-weight: 600;
  }
  input.control-item:focus { background: #3a3a3c; }

  /* --- Action Buttons --- */
  .btn-xl {
    width: 100%;
    height: 56px;
    border-radius: 16px;
    border: none;
    font-size: 17px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.1s;
    margin-top: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .btn-primary { background: var(--text); color: var(--bg); }
  .btn-primary:active { transform: scale(0.98); }
  .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--danger); margin-top: 16px; }
  
  .vote-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
  .vote-col { display: flex; flex-direction: column; gap: 8px; }
  .btn-vote {
    height: 48px;
    border-radius: 12px;
    border: 1px solid var(--card-highlight);
    background: transparent;
    color: var(--text-muted);
    font-weight: 500;
    cursor: pointer;
  }
  .btn-vote:hover, .btn-vote:active { border-color: var(--text); color: var(--text); background: var(--card-highlight); }

  /* --- Status & Feedback --- */
  .status-box {
    margin-top: 16px;
    padding: 12px;
    border-radius: 12px;
    background: var(--card-highlight);
    font-size: 13px;
    text-align: center;
    color: var(--text);
    display: none;
  }
  .status-box.error { color: var(--danger); background: rgba(255, 69, 58, 0.1); }

  /* --- Footer Info --- */
  .footer-info {
    padding: 24px;
    background: var(--card);
    border-radius: var(--radius);
    margin-top: auto;
  }
  .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: var(--text-muted); }
  .meta-link { display: block; text-align: center; margin-top: 16px; font-size: 12px; color: var(--text-muted); opacity: 0.6; text-decoration: none; }

  /* --- Utilities --- */
  .hidden { display: none !important; }
  .full-width { width: 100%; }
  
  /* Idea Box */
  .idea-chip {
    background: var(--card-highlight);
    padding: 10px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-style: italic;
    color: var(--text);
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  
  /* QR Section */
  #qrContainer { background: #fff; padding: 12px; border-radius: 16px; width: fit-content; margin: 0 auto 16px; }
  .share-input-row { display: flex; gap: 8px; background: var(--card-highlight); padding: 4px; border-radius: 14px; margin-bottom: 24px;}
  .share-input { flex: 1; background: transparent; border: none; color: var(--text-muted); font-size: 12px; padding-left: 12px; outline: none; }
  .btn-copy { background: var(--text); color: var(--bg); border: none; border-radius: 10px; font-size: 11px; font-weight: 700; padding: 0 12px; cursor: pointer; }

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
</head>

<body>

<div class="app">
  
  <div class="header">
    <div class="brand">ðŸ§ƒ The Juice</div>
    <button id="btnConnect" class="btn-connect">Connect Wallet</button>
  </div>

  <div class="nav-tabs">
    <button class="nav-btn active" onclick="switchTab('create')">Create</button>
    <button class="nav-btn" onclick="switchTab('manage')">Join / Resolve</button>
  </div>

  <div id="tab-create" class="view-panel active">
    
    <div class="card" style="padding-bottom: 32px;">
      <div class="idea-chip">
        <span id="ideaBoxText">"Hit the crossbar..."</span>
        <button id="btnShuffle" style="background:none; border:none; cursor:pointer; font-size:16px; padding:0;">ðŸŽ²</button>
        <input id="ideaBox" type="hidden" value=""/> 
      </div>

      <label class="label" style="text-align:center">I want to bet</label>
      <div class="hero-input-wrap">
        <div class="hero-row">
          <span id="currencySymbol" class="currency-symbol">Îž</span>
          <input id="stakeMain" class="hero-input" type="number" step="0.0001" value="0.0014" placeholder="0.00" />
        </div>
        <div class="currency-toggle-row">
           <button id="stakeModeEth" class="pill-xs active">ETH</button>
           <button id="stakeModeUsd" class="pill-xs">USD</button>
        </div>
      </div>

      <div class="control-grid">
        <button class="control-item" id="usd1">$1</button>
        <button class="control-item" id="usd5">$5</button>
        <button class="control-item" id="usd20">$20</button>
      </div>

      <label class="label">Join Deadline</label>
      <div class="control-grid">
        <button class="control-item" onclick="setJoin(15)">15m</button>
        <button class="control-item" onclick="setJoin(60)">1h</button>
        <button class="control-item" onclick="setJoin(1440)">1d</button>
        <input id="joinMins" type="number" class="control-item" value="15" placeholder="min">
      </div>

      <label class="label">Resolve Deadline</label>
      <div class="control-grid">
        <button class="control-item" onclick="setResolve(30)">30m</button>
        <button class="control-item" onclick="setResolve(120)">2h</button>
        <button class="control-item" onclick="setResolve(2880)">2d</button>
        <input id="resolveMins" type="number" class="control-item" value="30" placeholder="min">
      </div>

      <button id="btnCreate" class="btn-xl btn-primary">Create & Fund</button>
      <div id="createStatus" class="status-box"></div>
    </div>
  </div>

  <div id="tab-manage" class="view-panel">
    
    <div class="card">
      <label class="label">Bet ID</label>
      <div class="control-grid" style="margin-bottom:16px;">
        <input id="betId" class="control-item" style="flex:2; text-align:left; padding-left:16px; background:var(--card-highlight); color:var(--text); cursor:text; font-family:monospace" placeholder="Paste ID..." />
        <button id="btnNewBet" class="control-item" style="flex:1; font-size:13px">New ID</button>
      </div>

      <div id="shareSection" class="hidden" style="text-align:center;">
        <div id="qrContainer"><div id="qrBox"></div></div>
        <div class="share-input-row">
          <input id="shareUrl" class="share-input" readonly />
          <button id="btnCopy" class="btn-copy">Copy</button>
        </div>
        <p class="label" style="text-align:center; color:var(--accent); margin-bottom:24px;">Ready to share!</p>
      </div>

      <button id="btnJoin" class="btn-xl btn-primary">Join Bet</button>
      <button id="btnRefund" class="btn-xl btn-danger" style="height:44px; font-size:14px; background:transparent; color:var(--danger); border:1px solid rgba(255,69,58,0.3)">Request Refund</button>
    </div>

    <div class="card">
      <h2>Resolution</h2>
      <p class="label" style="text-align:center; margin-bottom:16px; opacity:0.7">Both parties must agree on the winner.</p>

      <div class="vote-grid">
        <div class="vote-col">
          <span class="label" style="text-align:center">Creator View</span>
          <button id="creatorWon" class="btn-vote">Creator Won</button>
          <button id="creatorSaysOpponent" class="btn-vote">Opponent Won</button>
        </div>
        <div class="vote-col">
          <span class="label" style="text-align:center">Joiner View</span>
          <button id="opponentSaysCreator" class="btn-vote">Creator Won</button>
          <button id="opponentWon" class="btn-vote">Opponent Won</button>
        </div>
      </div>

      <button id="btnPayout" class="btn-xl btn-primary" style="margin-top:24px; background:var(--accent)">Finalize Payout</button>
      <div id="actionStatus" class="status-box"></div>
    </div>
  </div>

  <div class="footer-info">
    <div class="info-row">
      <span>Total Pot</span>
      <span class="val-highlight"><span id="sbPotEth">0.0000</span> ETH <span style="opacity:0.5; font-weight:400">(<span id="sbPotUsd">$0.00</span>)</span></span>
    </div>
    <div class="info-row">
      <span>Winner Receives</span>
      <span class="val-highlight" style="color:var(--accent)"><span id="sbWinEth">0.0000</span> ETH <span style="opacity:0.5; font-weight:400">(<span id="sbWinUsd">$0.00</span>)</span></span>
    </div>
    <a id="lastTx" href="#" target="_blank" class="meta-link">Base Sepolia â€¢ Fee 2.5% â€¢ View Transaction</a>
  </div>

  <input id="stakeEth" type="hidden" value="0.0014"/>
  <input id="stakeUsd" type="hidden" value="5"/>
  <input id="feeBps" type="hidden" value="250"/>
  <button id="btnReset" class="hidden"></button> 
  <button id="ethMinus" class="hidden"></button>
  <button id="ethPlus" class="hidden"></button>
  <div id="sbState" class="hidden"></div>
  <div id="addrPill" class="hidden"></div>
  <div id="btnSwitch" class="hidden"></div>

</div>

<script>
/* -------------------------------------------------------------------------- */
/* UI UTILS                                                                   */
/* -------------------------------------------------------------------------- */
const $ = id => document.getElementById(id);

function switchTab(tab) {
  document.querySelectorAll('.view-panel').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  
  if(tab === 'create') {
    $('tab-create').classList.add('active');
    document.querySelectorAll('.nav-btn')[0].classList.add('active');
  } else {
    $('tab-manage').classList.add('active');
    document.querySelectorAll('.nav-btn')[1].classList.add('active');
  }
}

function setJoin(m) { $('joinMins').value = m; }
function setResolve(m) { $('resolveMins').value = m; }
function showStatus(elId, msg, isError=false) {
    const el = $(elId);
    el.style.display = 'block';
    el.textContent = msg;
    if(isError) el.classList.add('error'); else el.classList.remove('error');
}

/* -------------------------------------------------------------------------- */
/* CORE LOGIC                                                                 */
/* -------------------------------------------------------------------------- */
const BASE = { idHex: '0x14a34', rpc: 'https://sepolia.base.org', explorer: 'https://sepolia.basescan.org' };
const FEE_BPS = 250;        
let   ETH_USD = 3500;       
const CONTRACT_ADDRESS = '0xD251F4aFB44Fa54Af8E714C8219d5a535Bc59433'; 

function currentShareUrl() {
  const betId = $('betId').value;
  try {
    const u = new URL(location.href);
    if (betId) u.searchParams.set('bet', betId);
    else u.searchParams.delete('bet');
    return u.toString();
  } catch { return location.href; }
}

let qr = null;
function renderQR() {
  const node = $('qrBox'); node.innerHTML = '';
  const val = $('betId').value;
  
  if(val && val.length > 0) {
    $('shareSection').classList.remove('hidden');
    qr = new QRCode(node, { text: currentShareUrl(), width: 128, height: 128, colorDark:'#000000', colorLight:'#ffffff', correctLevel: QRCode.CorrectLevel.M });
  } else {
    $('shareSection').classList.add('hidden');
  }
}

function updatePreview() {
  const eth = parseFloat($('stakeEth').value || '0') || 0;
  const pot = eth * 2;
  const win = pot * (1 - FEE_BPS / 10000);

  if($('sbPotEth')) $('sbPotEth').textContent = pot.toFixed(4);
  if($('sbPotUsd')) $('sbPotUsd').textContent = '$' + (pot * ETH_USD).toFixed(2);
  if($('sbWinEth')) $('sbWinEth').textContent = win.toFixed(4);
  if($('sbWinUsd')) $('sbWinUsd').textContent = '$' + (win * ETH_USD).toFixed(2);
}

let stakeMode = 'ETH'; 
function applyStakeFromEth(rawEth) {
  const eth = Math.max(0, Number(rawEth) || 0);
  $('stakeEth').value = eth.toFixed(4);
  $('stakeUsd').value = (eth * ETH_USD).toFixed(0);
  updatePreview();
}

function handleStakeMainInput() {
  const num = Number($('stakeMain').value) || 0;
  if (stakeMode === 'ETH') {
    applyStakeFromEth(num);
  } else {
    const eth = num / ETH_USD;
    applyStakeFromEth(eth);
  }
}

function setStakeMode(mode) {
  if (mode !== 'ETH' && mode !== 'USD') return;
  stakeMode = mode;
  
  $('currencySymbol').textContent = mode === 'ETH' ? 'Îž' : '$';
  $('stakeModeEth').classList.toggle('active', mode === 'ETH');
  $('stakeModeUsd').classList.toggle('active', mode === 'USD');

  const eth = parseFloat($('stakeEth').value || '0') || 0;
  const input = $('stakeMain');
  
  if (mode === 'ETH') {
    input.step = '0.0001';
    input.value = eth.toFixed(4);
  } else {
    input.step = '1';
    input.value = (eth * ETH_USD).toFixed(0);
  }
}

/* Ethers */
let provider, signer;
const ABI = [
  {type:'function',stateMutability:'payable',   name:'createBet',   inputs:[{name:'stakeWei',type:'uint256'},{name:'feeBps',type:'uint16'},{name:'joinWindowSeconds',type:'uint64'},{name:'resolveWindowSeconds',type:'uint64'}], outputs:[{name:'betId',type:'uint256'}]},
  {type:'function',stateMutability:'payable',   name:'joinBet',     inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'confirmWinner',inputs:[{name:'betId',type:'uint256'},{name:'creatorWon',type:'bool'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'refund',      inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'resolve',     inputs:[{name:'betId',type:'uint256'}], outputs:[]},
  {type:'function',stateMutability:'view',      name:'getBet',      inputs:[{name:'betId',type:'uint256'}], outputs:[{type:'address'},{type:'address'},{type:'uint256'},{type:'uint16'},{type:'uint64'},{type:'uint64'},{type:'uint64'},{type:'uint8'},{type:'int8'},{type:'int8'}]},
  {type:'function',stateMutability:'view',      name:'nextBetId',   inputs:[], outputs:[{type:'uint256'}]}
];

async function ensureBase(){
  if (!window.ethereum) { alert('MetaMask not found'); throw new Error('no wallet'); }
  const chain = await window.ethereum.request({ method:'eth_chainId' });
  if (chain !== BASE.idHex){
    try{
      await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BASE.idHex }] });
    }catch(e){
      if (e.code === 4902){
        await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{ chainId: BASE.idHex, chainName:'Base Sepolia', nativeCurrency:{name:'ETH',symbol:'ETH',decimals:18}, rpcUrls:[BASE.rpc], blockExplorerUrls:[BASE.explorer]}] });
      } else { throw e; }
    }
  }
}

async function connect(){
  try{
    await ensureBase();
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts',[]);
    signer = await provider.getSigner();
    $('btnConnect').textContent = 'Connected';
    $('btnConnect').classList.add('connected');
  }catch(e){ console.error(e); }
}
function getContract(){
  if (!signer) throw new Error('Connect your wallet first.');
  return new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
}

/* Actions */
async function doCreate(){
  showStatus('createStatus', 'Please confirm in wallet...');
  try{
    if (!signer) await connect();
    const
