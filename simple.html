<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>The Juice</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>

<style>
  :root {
    --bg: #0A0B0D;
    --surface: #1E2026;
    --primary: #0052FF; /* Coinbase Blue */
    --primary-hover: #004ad9;
    --text: #FFFFFF;
    --text-secondary: #8A919E;
    --border: #2B2F36;
    --success: #05B169;
    --error: #DF3349;
    --radius: 16px;
    --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
  
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
  }

  /* --- Layout & Container --- */
  .app-container {
    width: 100%;
    max-width: 480px; /* Phone width focus */
    margin-top: 40px;
  }

  /* --- Header --- */
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
  }
  
  .brand { font-weight: 700; font-size: 20px; letter-spacing: -0.5px; }
  .brand span { color: var(--primary); }

  .wallet-btn {
    background: rgba(255,255,255,0.1);
    border: none;
    color: var(--text);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .wallet-btn:hover { background: rgba(255,255,255,0.15); }
  .wallet-btn.connected { background: rgba(5, 177, 105, 0.2); color: var(--success); }

  /* --- Cards --- */
  .card {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 32px 24px;
    box-shadow: 0 12px 32px rgba(0,0,0,0.2);
    margin-bottom: 20px;
    border: 1px solid var(--border);
  }

  /* --- Hero Input (The Money) --- */
  .money-group { text-align: center; margin-bottom: 30px; }
  .money-label { color: var(--text-secondary); font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
  
  .input-wrapper { position: relative; display: inline-block; margin-top: 10px; }
  .big-input {
    background: transparent;
    border: none;
    color: var(--text);
    font-size: 56px;
    font-weight: 500;
    text-align: center;
    width: 100%;
    outline: none;
    padding: 0;
    letter-spacing: -1px;
  }
  .big-input::placeholder { color: var(--border); }
  
  .currency-toggle {
    margin-top: 8px;
    color: var(--primary);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    background: none;
    border: none;
  }

  /* --- Details Grid --- */
  .details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 30px;
  }
  .detail-item label { display: block; color: var(--text-secondary); font-size: 12px; margin-bottom: 6px; }
  .detail-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
  }
  .detail-input:focus { border-color: var(--primary); }

  /* --- Buttons --- */
  .btn {
    width: 100%;
    padding: 18px;
    border-radius: 12px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.1s;
  }
  .btn:active { transform: scale(0.98); }
  
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: var(--primary-hover); }
  
  .btn-secondary { background: rgba(255,255,255,0.05); color: var(--text); margin-top: 12px; }
  .btn-danger { background: rgba(223, 51, 73, 0.15); color: var(--error); margin-top: 12px; }
  
  .btn-group { display: flex; gap: 12px; margin-top: 12px; }

  /* --- State Views --- */
  .hidden { display: none !important; }
  
  .status-pill {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    margin-bottom: 20px;
    width: 100%;
    text-align: center;
  }
  .status-open { background: rgba(0, 82, 255, 0.15); color: var(--primary); }
  .status-live { background: rgba(5, 177, 105, 0.15); color: var(--success); }
  .status-ended { background: var(--border); color: var(--text-secondary); }

  /* --- Vote Box --- */
  .vote-section { text-align: center; margin-top: 20px; }
  .vote-title { color: var(--text-secondary); font-size: 13px; margin-bottom: 10px; }

  /* --- QR & Share --- */
  #qrBox { display: flex; justify-content: center; margin: 20px 0; padding: 10px; background: white; border-radius: 12px; width: fit-content; margin-left: auto; margin-right: auto; }
  .share-link {
    background: var(--bg);
    padding: 12px;
    border-radius: 8px;
    font-family: monospace;
    color: var(--text-secondary);
    font-size: 12px;
    word-break: break-all;
    text-align: center;
    margin-bottom: 15px;
  }

  /* --- Toast/Notifications --- */
  .toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 10px 20px;
    border-radius: 30px;
    font-size: 14px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    z-index: 100;
  }
  .toast.show { opacity: 1; }

  /* --- Footer Info --- */
  .footer-info { text-align: center; margin-top: 30px; color: var(--text-secondary); font-size: 12px; }
  .footer-info a { color: var(--text-secondary); text-decoration: underline; }

</style>
</head>
<body>

  <div class="app-container">
    <header>
      <div class="brand">The<span>Juice</span></div>
      <button id="btnWallet" class="wallet-btn">Connect Wallet</button>
    </header>

    <div id="viewCreate" class="card">
      <div class="money-group">
        <div class="money-label">I want to bet</div>
        <div class="input-wrapper">
          <input id="inputAmount" type="number" class="big-input" placeholder="0.00" step="any">
        </div>
        <button id="toggleCurrency" class="currency-toggle">ETH</button>
      </div>

      <div class="details-grid">
        <div class="detail-item">
          <label>Join Deadline (Minutes)</label>
          <input id="joinMins" type="number" class="detail-input" value="15">
        </div>
        <div class="detail-item">
          <label>Resolve Deadline (Minutes)</label>
          <input id="resolveMins" type="number" class="detail-input" value="30">
        </div>
      </div>

      <div class="detail-item" style="margin-bottom: 20px;">
        <label>Total incl. 2.5% fee: <span id="previewTotal">0.00 ETH</span></label>
      </div>

      <button id="btnCreate" class="btn btn-primary">Create Bet</button>
    </div>

    <div id="viewManage" class="card hidden">
      <div id="betStatusPill" class="status-pill status-open">Loading...</div>
      
      <div class="money-group">
        <div class="money-label">Pot Size</div>
        <div class="big-input" id="potDisplay">0.00 ETH</div>
        <div class="currency-toggle" id="potUsdDisplay" style="cursor:default">$0.00</div>
      </div>

      <div id="actionJoin" class="hidden">
        <p style="text-align:center; color:var(--text-secondary); font-size:14px; margin-bottom:20px;">
          Your friend is betting <span id="joinStakeAmt">...</span> ETH.
        </p>
        <button id="btnJoin" class="btn btn-primary">Match Stake & Join</button>
      </div>

      <div id="actionVote" class="hidden">
        <p style="text-align:center; color:var(--text-secondary); font-size:14px;">Who won the bet?</p>
        <div class="btn-group">
          <button id="voteCreator" class="btn btn-secondary">Creator</button>
          <button id="voteOpponent" class="btn btn-secondary">Opponent</button>
        </div>
        <div id="myVoteStatus" style="text-align:center; margin-top:10px; color:var(--primary); font-size:12px;"></div>
      </div>

      <div id="actionPayout" class="hidden">
        <button id="btnResolve" class="btn btn-primary">Payout Winner</button>
      </div>

       <div id="actionRefund" class="hidden">
        <button id="btnRefund" class="btn btn-danger">Claim Refund</button>
      </div>

      <div id="shareSection" style="margin-top: 30px; border-top: 1px solid var(--border); padding-top:20px;">
        <div class="money-label" style="margin-bottom:15px">Share this bet</div>
        <div id="qrBox"></div>
        <div class="share-link" id="shareUrl">...</div>
        <button id="btnCopy" class="btn btn-secondary" style="padding:10px; font-size:14px;">Copy Link</button>
      </div>
    </div>

    <div class="footer-info">
      Contract: <a href="#" id="linkContract" target="_blank">View on BaseScan</a>
    </div>
  </div>

  <div id="toast" class="toast">Notification</div>

<script>
/* ---------- Configuration ---------- */
const CONFIG = {
  chainId: '0x14a34', // Base Sepolia
  rpc: 'https://sepolia.base.org',
  explorer: 'https://sepolia.basescan.org',
  contract: '0xD251F4aFB44Fa54Af8E714C8219d5a535Bc59433',
  feeBps: 250,
  ethPrice: 3500 // Fallback
};

/* ---------- State & Utils ---------- */
const state = {
  provider: null,
  signer: null,
  address: null,
  currency: 'ETH', // 'ETH' or 'USD'
  betId: null,
  contract: null
};

const $ = id => document.getElementById(id);
const toast = (msg) => {
  const t = $('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
};
const shortAddr = (a) => a ? `${a.substring(0,6)}...${a.substring(38)}` : '';

/* ---------- ABI ---------- */
const ABI = [
  "function createBet(uint256 stakeWei, uint16 feeBps, uint64 joinWindowSeconds, uint64 resolveWindowSeconds) payable returns (uint256)",
  "function joinBet(uint256 betId) payable",
  "function confirmWinner(uint256 betId, bool creatorWon)",
  "function refund(uint256 betId)",
  "function resolve(uint256 betId)",
  "function getBet(uint256 betId) view returns (address creator, address opponent, uint256 stakeWei, uint16 feeBps, uint64 joinDeadline, uint64 resolveDeadline, uint64 createdAt, uint8 state, int8 creatorVote, int8 opponentVote)",
  "function nextBetId() view returns (uint256)"
];

/* ---------- Wallet Logic ---------- */
async function initWallet() {
  if (!window.ethereum) return toast("Please install a wallet.");
  try {
    state.provider = new ethers.BrowserProvider(window.ethereum);
    const accounts = await state.provider.send("eth_requestAccounts", []);
    handleAccountsChanged(accounts);
    checkNetwork();
  } catch (e) { console.error(e); }
}

async function checkNetwork() {
  const net = await state.provider.getNetwork();
  if (Number(net.chainId) !== 84532) { // Base Sepolia ID
    try {
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: CONFIG.chainId }],
      });
    } catch (switchError) {
      // Check if the chain has not been added
      if (switchError.code === 4902) {
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [{
            chainId: CONFIG.chainId,
            chainName: 'Base Sepolia',
            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
            rpcUrls: [CONFIG.rpc],
            blockExplorerUrls: [CONFIG.explorer]
          }]
        });
      }
    }
  }
  state.signer = await state.provider.getSigner();
  state.contract = new ethers.Contract(CONFIG.contract, ABI, state.signer);
}

function handleAccountsChanged(accounts) {
  if (accounts.length === 0) {
    $('btnWallet').textContent = "Connect Wallet";
    $('btnWallet').classList.remove('connected');
    state.address = null;
  } else {
    state.address = accounts[0];
    $('btnWallet').textContent = shortAddr(accounts[0]);
    $('btnWallet').classList.add('connected');
  }
}

/* ---------- Logic: Create Bet ---------- */
function updateCreatePreview() {
  const val = parseFloat($('inputAmount').value) || 0;
  if (val === 0) { $('previewTotal').textContent = "0.00 ETH"; return; }
  
  let ethVal = state.currency === 'ETH' ? val : val / CONFIG.ethPrice;
  const total = ethVal; // Fee is taken FROM pot, not added on top in this contract logic, but let's display pure stake
  $('previewTotal').textContent = `${total.toFixed(5)} ETH Stake`;
}

$('toggleCurrency').onclick = () => {
  state.currency = state.currency === 'ETH' ? 'USD' : 'ETH';
  $('toggleCurrency').textContent = state.currency;
  updateCreatePreview();
};

$('inputAmount').addEventListener('input', updateCreatePreview);

$('btnCreate').onclick = async () => {
  if (!state.contract) await initWallet();
  
  const rawVal = parseFloat($('inputAmount').value);
  if (!rawVal) return toast("Enter an amount");

  const ethAmount = state.currency === 'USD' ? rawVal / CONFIG.ethPrice : rawVal;
  const weiAmount = ethers.parseEther(ethAmount.toFixed(18));
  const joinSecs = parseInt($('joinMins').value) * 60;
  const resolveSecs = parseInt($('resolveMins').value) * 60;

  $('btnCreate').textContent = "Confirming...";
  
  try {
    const tx = await state.contract.createBet(weiAmount, CONFIG.feeBps, joinSecs, resolveSecs, { value: weiAmount });
    toast("Transaction sent...");
    await tx.wait();
    
    // Predict ID (Next - 1)
    const nextId = await state.contract.nextBetId();
    const newId = Number(nextId) - 1;
    window.location.search = `?bet=${newId}`;
  } catch (e) {
    console.error(e);
    toast("Error: " + (e.shortMessage || e.message));
    $('btnCreate').textContent = "Create Bet";
  }
};

/* ---------- Logic: Manage/View Bet ---------- */
async function loadBet(id) {
  state.betId = id;
  $('viewCreate').classList.add('hidden');
  $('viewManage').classList.remove('hidden');
  
  if (!state.contract) await initWallet();

  try {
    const b = await state.contract.getBet(id);
    const betStruct = {
      creator: b[0],
      opponent: b[1],
      stake: b[2],
      state: b[7], // 0:Open, 1:Live, 2:Resolved, 3:Refunded
      creatorVote: b[8],
      opponentVote: b[9],
      joinDeadline: Number(b[4]),
      resolveDeadline: Number(b[5])
    };
    
    renderBetUI(betStruct);
  } catch (e) {
    console.error(e);
    $('betStatusPill').textContent = "Bet Not Found";
  }
}

function renderBetUI(bet) {
  const potEth = ethers.formatEther(bet.stake) * 2; // Pot is 2x stake
  const isMeCreator = state.address && bet.creator.toLowerCase() === state.address.toLowerCase();
  const isMeOpponent = state.address && bet.opponent.toLowerCase() === state.address.toLowerCase();
  const now = Math.floor(Date.now() / 1000);

  // 1. Status
  const statuses = ["Waiting for Opponent", "Live - In Progress", "Resolved - Paid", "Refunded"];
  const statusColors = ["status-open", "status-live", "status-ended", "status-ended"];
  $('betStatusPill').textContent = statuses[bet.state];
  $('betStatusPill').className = `status-pill ${statusColors[bet.state]}`;

  // 2. Money
  // If open, pot is just stake. If live, pot is 2x.
  const displayPot = bet.state === 0 ? ethers.formatEther(bet.stake) : potEth;
  $('potDisplay').textContent = parseFloat(displayPot).toFixed(4) + " ETH";
  $('potUsdDisplay').textContent = "â‰ˆ $" + (parseFloat(displayPot) * CONFIG.ethPrice).toFixed(2);

  // 3. Actions
  $('actionJoin').classList.add('hidden');
  $('actionVote').classList.add('hidden');
  $('actionPayout').classList.add('hidden');
  $('actionRefund').classList.add('hidden');
  $('shareSection').classList.add('hidden');

  // State 0: Open
  if (bet.state === 0) {
    $('shareSection').classList.remove('hidden');
    generateQR();
    
    if (!isMeCreator) {
      $('actionJoin').classList.remove('hidden');
      $('joinStakeAmt').textContent = ethers.formatEther(bet.stake);
      
      $('btnJoin').onclick = async () => {
        try {
          const tx = await state.contract.joinBet(state.betId, { value: bet.stake });
          toast("Joining...");
          await tx.wait();
          window.location.reload();
        } catch(e) { toast(e.shortMessage || "Error joining"); }
      };
    } else {
        // Creator can refund if deadline passed
        if (now > bet.joinDeadline) $('actionRefund').classList.remove('hidden');
    }
  }

  // State 1: Live
  if (bet.state === 1) {
    if (isMeCreator || isMeOpponent) {
       // Check if I voted
       const myVote = isMeCreator ? bet.creatorVote : bet.opponentVote;
       if (myVote === -1n || myVote === -1) { // -1 means no vote
          $('actionVote').classList.remove('hidden');
       } else {
          $('myVoteStatus').textContent = "You voted: " + (myVote == 1 ? "Creator" : "Opponent");
       }

       // Check for Consensus or Timeout
       if (bet.creatorVote !== -1n && bet.creatorVote === bet.opponentVote) {
         $('actionPayout').classList.remove('hidden');
       } else if (now > bet.resolveDeadline) {
         $('actionRefund').classList.remove('hidden'); // Disagreement refund
       }
    }
  }
  
  // Setup Vote Buttons
  $('voteCreator').onclick = () => sendVote(true);
  $('voteOpponent').onclick = () => sendVote(false);
  $('btnResolve').onclick = async () => {
      try { await (await state.contract.resolve(state.betId)).wait(); window.location.reload(); } catch(e){ toast(e.message); }
  };
  $('btnRefund').onclick = async () => {
      try { await (await state.contract.refund(state.betId)).wait(); window.location.reload(); } catch(e){ toast(e.message); }
  };
}

async function sendVote(creatorWon) {
    try {
        const tx = await state.contract.confirmWinner(state.betId, creatorWon);
        toast("Submitting vote...");
        await tx.wait();
        window.location.reload();
    } catch(e) { toast(e.shortMessage || "Error voting"); }
}

/* ---------- QR & Share ---------- */
function generateQR() {
  const url = window.location.href;
  $('shareUrl').textContent = url;
  $('qrBox').innerHTML = '';
  new QRCode($('qrBox'), { text: url, width: 120, height: 120, colorDark: "#000000", colorLight: "#ffffff" });
}
$('btnCopy').onclick = () => {
  navigator.clipboard.writeText(window.location.href);
  toast("Link copied!");
};

/* ---------- Initialization ---------- */
window.addEventListener('DOMContentLoaded', () => {
  $('linkContract').href = `${CONFIG.explorer}/address/${CONFIG.contract}`;
  
  // Check URL for ?bet=ID
  const params = new URLSearchParams(window.location.search);
  const betId = params.get('bet');

  if (betId) {
    loadBet(betId);
  } else {
    // We are creating
    $('inputAmount').focus();
  }

  $('btnWallet').onclick = initWallet;
});

</script>
</body>
</html>
